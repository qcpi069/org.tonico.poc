<statements>
	
	<property name="schema" value="VRAP"/>

	<!-- Statements used by com.caremark.gdx.rateload.dao.FileExportConfigDAOOracle -->
	<group name="Everything">
		<statement name="TFORMULARY_CONSOLIDATED"><![CDATA[
            SELECT DISTINCT
                   A.FRMLY_ID,
                   A.FRMLY_SRC_CD,
                   A.FORMULARY_NM
            FROM VRAP.TFRMLY_OFF_WORK A
            WHERE (A.TYP_CD = 4 OR A.GRP_CNT > 1)
            WITH UR
		]]></statement>
	    <statement name="TDRUG_EDW"><![CDATA[
            SELECT DISTINCT 
                   BRND_NAM,
                   LABL_NM,
                   DRUG_NDC_ID,
                   DRUG_END_DT,
                   GCN_CD,
                   GPI_LC10_ID
            FROM VRAP.TFRMLY_OFF_WORK A
            WHERE (A.TYP_CD = 4 OR A.GRP_CNT > 1)
            WITH UR
		]]></statement>
	    <statement name="FRMLY_EXP_CNTRL_CURRENT"><![CDATA[
			SELECT A.ON_OFF_FRMLY_STAT, 
	       	       A.ON_OFF_FRMLY_PRD
			FROM   VRAP.TFRMLY_EXP_CNTL A
			WHERE  A.FRMLY_EXP_ID = (SELECT MAX(FRMLY_EXP_ID) FROM VRAP.TFRMLY_EXP_CNTL)
			AND    A.RUN_STAT = 2
		]]></statement>
		<statement name="FRMLY_EXP_CNTRL_UPDATE"><![CDATA[
			UPDATE VRAP.TFRMLY_EXP_CNTL A
			SET    A.RUN_STAT = 3
			WHERE  A.FRMLY_EXP_ID = (SELECT MAX(FRMLY_EXP_ID) FROM VRAP.TFRMLY_EXP_CNTL)
			AND    A.RUN_STAT = 2
		]]></statement>
	    <statement name="TDISCNT_PERIOD"><![CDATA[
			SELECT PERIOD.PERIOD_BEGIN_DT,
			PERIOD.PERIOD_END_DT
			FROM VRAP.TDISCNT_PERIOD PERIOD
			WHERE PERIOD.PERIOD_ID = ?
			WITH UR
		]]></statement>
	    <statement name="DELETE_FROM_ON_FRMLY"><![CDATA[
			DELETE FROM VRAP.TFRMLY_ON A
			WHERE A.PERIOD_ID = '#PERIOD_ID#'
		]]></statement>
	    <statement name="DELETE_FROM_OFF_FRMLY"><![CDATA[
			DELETE FROM VRAP.TFRMLY_OFF A
			WHERE A.PERIOD_ID = '#PERIOD_ID#'
		]]></statement>
	    <statement name="ON_FRMLY"><![CDATA[
			SELECT A.DRUG_NDC_ID, 
				   A.FRMLY_ID, 
				   A.FRMLY_SRC_CD,
				   A.ON_FRMLY_EFF_DT,
				   A.ON_FRMLY_END_DT 
		    FROM VRAP.TFRMLY_ON A
			WHERE A.FRMLY_ID = ?
			AND   A.DRUG_NDC_ID = ?
			AND   A.FRMLY_SRC_CD = ?
			ORDER BY A.ON_FRMLY_EFF_DT
			WITH UR
		]]></statement>
	    <statement name="OFF_FRMLY"><![CDATA[
			INSERT INTO VRAP.TFRMLY_OFF (PERIOD_ID, 
	                                 PERIOD_BEGIN_DT, 
	                                 PERIOD_END_DT,
	                                 FRMLY_ID,
	                                 FORMULARY_NM,
	                                 FRMLY_SRC_CD,
	                                 FRMLY_END_DT,
	                                 BRND_NAM,
	                                 LABL_NM,
	                                 DRUG_NDC_ID,
	                                 DRUG_END_DT,
	                                 OFF_FRMLY_EFF_DT,
	                                 OFF_FRMLY_END_DT,
	                                 GCN_CD,
	                                 GPI_LC10_ID)
							VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
		]]></statement>
	    <statement name="CURRENT_ON_FRMLY"><![CDATA[
			SELECT DISTINCT
			    B.PERIOD_ID,                      
			    B.PERIOD_BEGIN_DT,              
			    B.PERIOD_END_DT,                 
			    B.FRMLY_ID,                       
			    B.FORMULARY_NM,                     
			    B.FRMLY_SRC_CD,                   
			    B.FRMLY_END_DT,                   
			    B.BRND_NAM,                     
			    B.LABL_NM,                       
			    B.DRUG_NDC_ID,                    
			    B.DRUG_END_DT,                               
			    B.GCN_CD,                            
			    B.GPI_LC10_ID,
			    B.ON_FRMLY_EFF_DT, 
			    B.ON_FRMLY_END_DT
			FROM VRAP.TFRMLY_OFF_WORK A,
			     VRAP.TFRMLY_ON B
			WHERE A.FRMLY_ID     = B.FRMLY_ID
			AND   A.FRMLY_SRC_CD = B.FRMLY_SRC_CD
			AND   A.DRUG_NDC_ID  = B.DRUG_NDC_ID
			AND   A.TYP_CD = 4
			AND   B.PERIOD_ID = '#PERIOD_ID#'
			UNION
			SELECT DISTINCT
			    B.PERIOD_ID,                      
			    B.PERIOD_BEGIN_DT,              
			    B.PERIOD_END_DT,                 
			    B.FRMLY_ID,                       
			    B.FORMULARY_NM,                     
			    B.FRMLY_SRC_CD,                   
			    B.FRMLY_END_DT,                   
			    B.BRND_NAM,                     
			    B.LABL_NM,                       
			    B.DRUG_NDC_ID,                    
			    B.DRUG_END_DT,                               
			    B.GCN_CD,                            
			    B.GPI_LC10_ID,
			    B.ON_FRMLY_EFF_DT, 
			    B.ON_FRMLY_END_DT
			FROM VRAP.TFRMLY_OFF_WORK A,
			     VRAP.TFRMLY_ON B
			WHERE A.FRMLY_ID     = B.FRMLY_ID
			AND   A.FRMLY_SRC_CD = B.FRMLY_SRC_CD
			AND   A.DRUG_NDC_ID  = B.DRUG_NDC_ID
			AND   A.GRP_CNT > 1
			AND   B.PERIOD_ID = '#PERIOD_ID#'
			ORDER BY FRMLY_ID, FRMLY_SRC_CD, DRUG_NDC_ID, ON_FRMLY_EFF_DT
			WITH UR
		]]></statement>
	    <statement name="CLEAR_OFF_FRMLY_WORK"><![CDATA[
			DELETE FROM VRAP.TFRMLY_OFF_WORK
		]]></statement>
	    <statement name="INSERT_DIRECT_COPIES"><![CDATA[
			INSERT INTO VRAP.TFRMLY_OFF
			SELECT                       
			    A.PERIOD_ID,                      
			    A.PERIOD_BEGIN_DT,              
			    A.PERIOD_END_DT,                 
			    A.FRMLY_ID,                       
			    A.FORMULARY_NM,                     
			    A.FRMLY_SRC_CD,                   
			    A.FRMLY_END_DT,                   
			    A.BRND_NAM,                     
			    A.LABL_NM,                       
			    A.DRUG_NDC_ID,                    
			    A.DRUG_END_DT,                   
			    A.OFF_FRMLY_EFF_DT,              
			    A.OFF_FRMLY_END_DT,              
			    A.GCN_CD,                            
			    A.GPI_LC10_ID                      
			FROM VRAP.TFRMLY_OFF_WORK A
			WHERE A.TYP_CD IN (2, 3, 5)
			AND   A.GRP_CNT = 1
		]]></statement>
	    <statement name="POPULATE_ON_FRMLY"><![CDATA[		
			INSERT INTO VRAP.TFRMLY_ON (PERIOD_ID, 
	                                  PERIOD_BEGIN_DT, 
	                                  PERIOD_END_DT, 
	                                  FRMLY_ID, 
	                                  FORMULARY_NM, 
	                                  FRMLY_SRC_CD, 
	                                  FRMLY_END_DT, 
	                                  BRND_NAM, 
	                                  LABL_NM, 
	                                  DRUG_NDC_ID, 
	                                  DRUG_END_DT, 
	                                  ON_FRMLY_EFF_DT, 
	                                  ON_FRMLY_END_DT, 
	                                  GCN_CD, 
	                                  GPI_LC10_ID) 
			(SELECT
			    '#PERIOD_ID#' AS PERIOD_ID,
			    PERIOD.PERIOD_BEGIN_DT,
			    PERIOD.PERIOD_END_DT,
			    DSTAT.FRMLY_ID,
			    FRMLY.FORMULARY_NM,
			    FRMLY.FRMLY_SRC_CD,
			    FRMLY.END_DT AS FRMLY_END_DT,
			    DRUG.BRND_NAM,
			    DRUG.LABL_NM,
			    DRUG.DRUG_NDC_ID,
			    DRUG.DRUG_END_DT,
			    CASE
			        WHEN DSTAT.EFF_DT < PERIOD.PERIOD_BEGIN_DT THEN
			             PERIOD.PERIOD_BEGIN_DT
			        ELSE 
			             DSTAT.EFF_DT
			    END AS ON_FRMLY_EFF_DT,
			    CASE 
			        WHEN DSTAT.END_DT > PERIOD.PERIOD_END_DT THEN
			             PERIOD.PERIOD_END_DT
			        ELSE
			             DSTAT.END_DT
			    END AS ON_FRMLY_END_DT,
			    DRUG.GCN_CD,
			    DRUG.GPI_LC10_ID
			 FROM VRAP.TDISCNT_PERIOD PERIOD,
			      VRAP.TFORMULARY_DRUG_STATUS DSTAT,
			      VRAP.TFORMULARY_CONSOLIDATED FRMLY, 
			      VRAP.TDRUG_RBAT DRUG
			 WHERE PERIOD.PERIOD_ID = '#PERIOD_ID#'
			 And   DSTAT.PERIOD_ID = '#PERIOD_ID#'
			 AND   DSTAT.FRMLY_ID = FRMLY.FRMLY_ID
			 AND   DSTAT.FRMLY_SRC_CD = FRMLY.FRMLY_SRC_CD
			 AND   DSTAT.DRUG_NDC_ID = DRUG.DRUG_NDC_ID
			 AND   (DSTAT.EFF_DT BETWEEN PERIOD.PERIOD_BEGIN_DT AND PERIOD.PERIOD_END_DT OR
			        DSTAT.END_DT BETWEEN PERIOD.PERIOD_BEGIN_DT AND PERIOD.PERIOD_END_DT OR
			        (DSTAT.EFF_DT < PERIOD.PERIOD_BEGIN_DT AND DSTAT.END_DT > PERIOD.PERIOD_END_DT))
			)
		]]></statement>
	    <statement name="OFF_FRMLY_WORK"><![CDATA[
			INSERT INTO VRAP.TFRMLY_OFF_WORK
			SELECT 
			CASE   WHEN ALL.EFF_DT = FON.ON_FRMLY_EFF_DT AND
			            ALL.END_DT = FON.ON_FRMLY_END_DT
			       THEN 1
			       WHEN ALL.EFF_DT = FON.ON_FRMLY_EFF_DT AND
			            ALL.END_DT != FON.ON_FRMLY_END_DT
			       THEN 2
			       WHEN ALL.END_DT = FON.ON_FRMLY_END_DT AND
			            ALL.EFF_DT != FON.ON_FRMLY_EFF_DT
			       THEN 3
			       WHEN FON.ON_FRMLY_EFF_DT IS NOT NULL
			       THEN 4
			       ELSE 5
			END TYP_CD
			, COUNT(*) OVER (PARTITION BY ALL.FRMLY_ID, ALL.FRMLY_SRC_CD, ALL.DRUG_NDC_ID) GRP_CNT
			, all.period_id
			, all.eff_dt
			, all.end_dt
			, all.frmly_id
			, all.formulary_nm
			, all.frmly_src_cd
			, all.frmly_end_dt
			, all.brnd_nam
			, all.labl_nm
			, all.drug_ndc_id
			, all.drug_end_dt
			, CASE WHEN ALL.eff_dt = fon.ON_FRMLY_EFF_DT AND
			            ALL.end_dt = fon.ON_FRMLY_END_DT
			       THEN  CAST(NULL AS DATE) 
			       WHEN ALL.eff_dt = fon.ON_FRMLY_EFF_DT AND
			            ALL.end_dt != fon.ON_FRMLY_END_DT
			       THEN fon.ON_FRMLY_END_DT + 1 day
			       WHEN ALL.end_dt = fon.ON_FRMLY_END_DT AND
			            ALL.eff_dt != fon.ON_FRMLY_EFF_DT
			       THEN ALL.eff_dt
			       WHEN FON.ON_FRMLY_EFF_DT IS NOT NULL
			       THEN FON.ON_FRMLY_EFF_DT
			       ELSE  ALL.EFF_DT
			   END EFF_DT
			, CASE WHEN all.eff_dt = fon.ON_FRMLY_EFF_DT AND
			            all.end_dt = fon.ON_FRMLY_END_DT
			       THEN CAST(NULL AS DATE)
			       WHEN all.eff_dt = fon.ON_FRMLY_EFF_DT AND
			            all.end_dt != fon.ON_FRMLY_END_DT
			       THEN all.end_dt
			       WHEN all.end_dt = fon.ON_FRMLY_END_DT AND
			            all.eff_dt != fon.ON_FRMLY_EFF_DT
			       THEN FON.ON_FRMLY_EFF_DT - 1 day
			       WHEN FON.ON_FRMLY_END_DT IS NOT NULL
			       THEN FON.ON_FRMLY_END_DT
			       ELSE ALL.END_DT
			   END END_DT
			, ALL.GCN_CD
			, ALL.GPI_LC10_ID
			from
			(
			 SELECT f.FRMLY_ID, f.FRMLY_SRC_CD, f.FORMULARY_NM, f.END_DT frmly_end_dt
			      , d.BRND_NAM, d.DRUG_NDC_ID, d.LABL_NM, d.DRUG_END_DT, d.GCN_CD, d.GPI_LC10_ID
			      , date('#PERIOD_START#') eff_dt, date('#PERIOD_END#') end_dt, '#PERIOD_ID#' PERIOD_ID
			        FROM VRAP.TDRUG_RBAT d
			      , vrap.tformulary_consolidated f
			  where f.FRMLY_SRC_CD in ('S','H','P')
			) all
			LEFT JOIN VRAP.TFRMLY_ON fon
			ON all.FRMLY_ID = fon.FRMLY_ID
			AND all.FRMLY_SRC_CD = fon.FRMLY_SRC_CD
			AND all.DRUG_NDC_ID = fon.DRUG_NDC_ID
			AND fon.PERIOD_ID = '#PERIOD_ID#'
		]]></statement>
	</group>
</statements>