<!-- LOAD MIGRATED PHC CAG FROM CLIENT REG TO GOLD  -->
 
<sqml>
	<property name="TIMEOUT" value="0"/>
	<datasources resource="datasource.xml"/>
 
	<command type="try">
	    <try>

                 <!-- Delete table for reload -->
                 <command type="run" datasource="edwdb" transaction="true"><![CDATA[
                       delete from DMA_RBATE2.T_RXMAX_CAG_DETAIL
                 ]]></command>

		    <!-- Copy info from Client Reg to GOLD DMA_RBATE2 -->
		    <command type="copy" batch="600">
			<source type="sql" datasource="silver"><![CDATA[
			     select *			   
			     from ( SELECT DISTINCT			   
			           /*+ ordered full(reb_inv) full(ccna) use_hash(reb_inv) use_hash(ccna) */	
			           RTRIM(CLNT.ap_compny_cd) as ap_compny_cd,			   
			           RTRIM(ccna.extl_src_cd) AS extnl_src_code			   
			          ,RTRIM(ccna.extl_lvl1_id) AS extnl_lvl_id1			   
			          ,RTRIM(ccna.extl_lvl2_id) AS extnl_lvl_id2			   
			          ,RTRIM(ccna.extl_lvl3_id) AS extnl_lvl_id3
			          ,RTRIM(ccna.extl_lvl4_id) AS extnl_lvl_id4 
			          ,RTRIM(ccna.extl_lvl5_id) AS extnl_lvl_id5 
			          ,(CASE WHEN TRUNC(ccna.client_nbr_eff_dt) < NVL(reb_inv.rebate_inv_eff_dt,TO_DATE('01011900','MMDDYYYY'))
			                 THEN TRUNC(reb_inv.rebate_inv_eff_dt)			   
			                 ELSE TRUNC(ccna.client_nbr_eff_dt)			   
			                 END) as eff_date			   
			          ,(CASE WHEN (TRUNC(ccna.client_nbr_term_dt)+0.99999) < NVL((TRUNC(reb_inv.rebate_inv_term_dt)+0.99999),(TO_DATE('12319999','mmddyyyy')+0.99999))
			                 THEN TRUNC(ccna.client_nbr_term_dt)+0.99999 -- when CCNA term is sooner than RI, use CCNA
			                 ELSE NVL((TRUNC(reb_inv.rebate_inv_term_dt)+0.99999),(TRUNC(ccna.client_nbr_term_dt)+0.99999)) -- if RI term date is sooner than CCNA, use RI unless null
			                 END) as end_date  			                			   
			      FROM  rbate_reg.client clnt			   
			            ,rbate_reg.rebate_invoice reb_inv			   
			            ,rbate_reg.cg_client_nbr_assoc ccna			   
			       WHERE clnt.pcs_system_id                     = reb_inv.pcs_system_id			   
			       AND   RTRIM(clnt.client_nbr)                 = RTRIM(ccna.client_nbr)   			   
			       AND   clnt.ap_compny_cd  IN ('624', '607')			   
			       and ccna.extl_src_cd not in ('PHC', 'PHCE') 			   
			       ) TMP			   
			       WHERE TMP.end_date >= TO_DATE('07/01/2007', 'MM/DD/YYYY')			   
			       AND TMP.end_date  >=TMP.EFF_DATE 	   

			]]></source>
			<target
			    type             = "sql"
			    datasource       = "edwdb"
			    transaction      = "false"
			    batch            = "600"
			    reportInterval   = "600"
			    queryTimeout     = "${TIMEOUT}"
			><![CDATA[
			    INSERT INTO DMA_RBATE2.T_RXMAX_CAG_DETAIL (AP_COMPNY_CD,EXTNL_SRC_CODE ,EXTNL_LVL_ID1 ,
			    EXTNL_LVL_ID2,EXTNL_LVL_ID3,EXTNL_LVL_ID4 ,EXTNL_LVL_ID5 ,EFF_DATE ,END_DATE )
			    VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?)
			]]></target>
		    </command>

		</try>
		<catch>
			<!-- Send an email on error -->
			<command
				type="mail"
				mailTo="gdxitd@caremark.com"
				mailFrom="Migrated_phc_cag_load@caremark.com"
				subject="[ERROR] load_migrated_phc_cag_to_gold - temp_table_name error "
				contentType="text/html"
				throwsException="false"
			><![CDATA[
				<html>
				<head>
				<title>[ERROR] LOAD MIGRATED PHC CAG TO GOLD </title>
				</head>
				<body>
			
				<h3><u>[ERROR] LOAD MIGRATED PHC CAG TO GOLD </u></h3>
			
				<table cellpadding="2">
					<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
					<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
					<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
					#if (${system.getProperty('logfile')})
						<tr>
							<td><b>Log File:</b></td>
							<td>
								${system.getProperty('logfile')}
							<td>
						</tr>
					#end
				</table>

				<br>			
				<br>
				
				#if (${script.getLastStatement()})
					<h3><u>Last Statement</u></h3>
					<font style="color: blue; font-size: small">	
					${script.getLastStatement()}
					</font>
				
					<br>
					<br>
				#end
			
				<h3><u>Stack Trace</u></h3>		
				<pre style="color: red; font-size: small;">${stackTrace}</pre>
				</body>
				</html>
			]]></command>
		</catch>
        </command>
</sqml>
