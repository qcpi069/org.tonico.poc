
<!--   
     Loads RPS.TCLAIM_SMRY information for a specific quarter from GDX into RPS Datamart 
     Datasource definition file datasource.xml is in the ./java/Common_java_db_interface/conf.
     The XML file should reside under ./xml directory

     Parameter 1 : Required, "dashdashmodel <model>". This should be the parameter passed into XML.
                   Note: hyphenhyphen means the two dash characters.

     Maestro Command with parameter: ./scripts/Common_java_db_interface.ksh dashdashmodel XMD <xml file name>
-->
<sqml>	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->
	<datasources resource="datasource.xml"/>
	
	<!-- Set-up a try block to send an email on exception.	--> 
	<command type="try">
	   <try>
                <!-- Query DB for current begin and end date info -->
                <command type="run" datasource="gdxprd" rowName="row"><![CDATA[

			SELECT CHAR(PERIOD_BEGIN_DT), CHAR(PERIOD_END_DT), RTRIM(CHAR(QUARTER_ID))
   			  FROM VRAP.TDISCNT_PERIOD
			 WHERE PERIOD_LEVEL = 'QUARTER'  
                           AND QUARTER_ID = (SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD) 
                          WITH UR;

                ]]></command>

                <!-- Command to set quarter parameters, either from DB or parameter-->
                <command type="java"><![CDATA[

                         String beginD = "";
                         String endD = "";
                         String model = "";
                         String model_typ_cd = "";
                         String quarter = "";

                         //Make the variables available to other queries below
                         model = script.getProperty("model");
                         script.setProperty("model", model);

                         model_typ_cd = model.substring(0,1);
                         script.setProperty("model_typ_cd", model_typ_cd);

                         beginD = script.getProperty("row.1");
                         endD = script.getProperty("row.2");
                         quarter =  script.getProperty("row.3");

                         //Make the variables available to other queries below
                         script.setProperty("beginD", beginD);
                         script.setProperty("endD", endD);
                         script.setProperty("quarter",quarter);

                ]]></command>

                <!-- delete rows for the current billing quarter -->
                <command type="run" datasource="datamart" transaction="true"><![CDATA[

                        	DELETE 
                                  FROM RPS.TCLAIM_SMRY
                                 WHERE QUARTER_ID = (SELECT QUARTER_ID FROM RPS.TCUR_INV_PRD)
                                   AND MODEL_TYP_CD = '${model_typ_cd}'

                ]]></command>

                <!-- Insert the report information for current APC quarter  -->
                <command type="copy" batch="500">
                         <source type="sql" datasource="gdxprd"><![CDATA[

                            WITH
                                 SET_A (MODEL_TYP_CD, TOT_CLM_QTY ) AS (
                                SELECT '${model_typ_cd}', COUNT(CLAIM_ID) 
 		                  FROM VRAP.VCLAIM_${model} VC
                                 WHERE VC.INV_ELIG_DT BETWEEN '${beginD}' AND '${endD}'
				 ),
			 	 SET_B (MODEL_TYP_CD, RBAT_CLM_QTY, MKSR_RBAT_CLM_QTY) AS (
				SELECT '${model_typ_cd}', COUNT(DISTINCT CLAIM_ID) , 
                                       COUNT(DISTINCT(CASE WHEN MKSR_RPT_ID IS NOT NULL THEN CLAIM_ID END ))
  		                  FROM VRAP.TDISCNT_EXT_CLAIM_${model} 
                                 WHERE HVST_ID IN
         		                       (SELECT HVST_ID 
                                                  FROM VRAP.TDISCNT_APC_RPT
             		                         WHERE QUARTER_ID = (SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD) 
                                               )
                                 ),
                                 SET_C (QUARTER_ID, MODEL_TYP_CD, CLT_MKSR_RBAT_CLM_QTY)  AS (
				SELECT ${quarter}, '${model_typ_cd}', SUM(TOT_CLM_CNT_QTY)   
      			          FROM VRAP.TDISCNT_MSTAR_SMRY 
   				 WHERE MODEL_TYP_CD = '${model_typ_cd}' 
                                   AND QUARTER_ID = (SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD) 
                                 )

                                SELECT C.QUARTER_ID,  A.MODEL_TYP_CD,  A.TOT_CLM_QTY, B.RBAT_CLM_QTY,
		                       B.MKSR_RBAT_CLM_QTY,  
                                       COALESCE(C.CLT_MKSR_RBAT_CLM_QTY, 0) 
                                  FROM SET_A A , SET_B B , SET_C C 
                                 WHERE A.MODEL_TYP_CD = B.MODEL_TYP_CD
                                   AND B.MODEL_TYP_CD = C.MODEL_TYP_CD

                         ]]></source>

                         <target
                                type           = "sql"
                                datasource     = "datamart"
                                transaction    = "true"
                                batch          = "500"
                                reportInterval = "500"
                                queryTimeout   = "${TIMEOUT}"
                         ><![CDATA[

                               INSERT INTO RPS.TCLAIM_SMRY (
                                      QUARTER_ID,
                                      MODEL_TYP_CD,
                                      TOT_CLM_QTY,
                                      RBAT_CLM_QTY,
                                      MKSR_RBAT_CLM_QTY,
				      CLT_MKSR_RBAT_CLM_QTY          
                                      )
                               VALUES (?, ?,  ?, ?, ?, ?)

                         ]]></target>
              </command>

          </try>
                 <catch>
                        <!-- Send an email on error -->
                        <command
                                type="mail"
                                mailTo="${email_address}"
                                mailFrom="TCLAIM_SMRY@caremark.com"
                                subject="[ERROR] GDX_GD_7860J_claim_smry.xml"
                                contentType="text/html"
                                throwsException="false"
                        ><![CDATA[
                                <html>
                                <head>
                                <title>[ERROR] GDX_GD_7860J_claim_smry.xml</title>
                                </head>
                                <body>

                                <h3><u>[ERROR] GDX_GD_7860J_claim_smry.xml</u></h3>

                                <table cellpadding="2">
                                        <tr><td><b>Host:</b></td><td>${localhost}<td></tr>
                                        <tr><td><b>Started:</b></td><td>${startTime}<td></tr>
                                        <tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
                                        #if (${system.getProperty('logfile')})
                                                <tr>
                                                        <td><b>Log File:</b></td>
                                                        <td>
                                                                ${system.getProperty('logfile')}
                                                        <td>
                                                </tr>
                                        #end
                                </table>

                                <br>
                                <br>
                                #if (${script.getLastStatement()})
                                        <h3><u>Last Statement</u></h3>
                                        <font style="color: blue; font-size: small">
                                        ${script.getLastStatement()}
                                        </font>

                                        <br>
                                        <br>
                                #end

                                <h3><u>Stack Trace</u></h3>
                                <pre style="color: red; font-size: small;">${stackTrace}</pre>
                                </body>
                                </html>
                        ]]></command>
                </catch>
        </command>
</sqml>

		
