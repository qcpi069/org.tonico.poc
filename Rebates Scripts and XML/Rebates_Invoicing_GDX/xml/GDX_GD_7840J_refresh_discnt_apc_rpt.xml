
<!--   
     Loads TDISCNT_APC_RPT and TCUR_INV_PRD information for a specific quarter from GDX into RPS Datamart 
     Datasource definition file datasource.xml is in the ./java/Common_java_db_interface/conf.
     The XML file should reside under ./xml directory
     Maestro Command without parameter: ./scripts/Common_java_db_interface.ksh <xml file name>
-->
<sqml>	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->
	<datasources resource="datasource.xml"/>
	
	<!-- Set-up a try block to send an email on exception.	--> 
	<command type="try">
	   <try>
                <!-- delete existing rows from TCUR_INV_PRD -->
                <command type="run" datasource="datamart" transaction="true"><![CDATA[

                         DELETE FROM RPS.TCUR_INV_PRD

                ]]></command>

                <!-- This is the actual extract and load, extract from source, load into target-->
                <command type="copy" batch="500">
                        <source type="sql" datasource="gdxprd"><![CDATA[

                                SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD

                        ]]></source>
                        <target
                                type           = "sql"
                                datasource     = "datamart"
                                transaction    = "true"
                                batch          = "500"
                                reportInterval = "500"
                                queryTimeout   = "${TIMEOUT}"
                        ><![CDATA[

                                INSERT INTO RPS.TCUR_INV_PRD (QUARTER_ID) VALUES (?)
 
                        ]]></target>
                </command>

                <!-- delete rows for the current billing quarter -->
                <command type="run" datasource="datamart" transaction="true"><![CDATA[

                        	DELETE 
                                  FROM RPS.TDISCNT_APC_RPT
                                 WHERE QUARTER_ID = (SELECT QUARTER_ID FROM RPS.TCUR_INV_PRD)

                ]]></command>

                <!-- Insert the report information for current APC quarter  -->
                <command type="copy" batch="500">
                         <source type="sql" datasource="gdxprd"><![CDATA[

                               SELECT QUARTER_ID,
                                      PERIOD_BEGIN_DT, PERIOD_END_DT,
                                      PERIOD_ID, DISCNT_RUN_MODE_CD,
                                      MODEL_TYP_CD, VNDR_ID,
                                      PICO_NB, VNDR_NM,
                                      CNTRCT_ID, CNTRCT_TX,
                                      PMT_SYS_ELIG_CD, HRCY_TYP_CD,
                                      RPT_ID, RPT_TITLE,
                                      RPT_TYP_CD, HVST_ID
                                 FROM VRAP.TDISCNT_APC_RPT
                                WHERE QUARTER_ID = (SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD)

                         ]]></source>

                         <target
                                type           = "sql"
                                datasource     = "datamart"
                                transaction    = "true"
                                batch          = "500"
                                reportInterval = "50000"
                                queryTimeout   = "${TIMEOUT}"
                         ><![CDATA[

                               INSERT INTO RPS.TDISCNT_APC_RPT (
                                      QUARTER_ID,
                                      PERIOD_BEGIN_DT, PERIOD_END_DT,
                                      PERIOD_ID, DISCNT_RUN_MODE_CD,
                                      MODEL_TYP_CD, VNDR_ID,
                                      PICO_NB, VNDR_NM,
                                      CNTRCT_ID, CNTRCT_TX,
                                      PMT_SYS_ELIG_CD, HRCY_TYP_CD,
                                      RPT_ID, RPT_TITLE,
                                      RPT_TYP_CD, HVST_ID
                                      )
                               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

                         ]]></target>
              </command>

          </try>
                 <catch>
                        <!-- Send an email on error -->
                        <command
                                type="mail"
                                mailTo="${email_address}"
                                mailFrom="CP_TDISCNT_APC_RPT@caremark.com"
                                subject="[ERROR] GDX_GD_7840J_refresh_discnt_apc_rpt.xml"
                                contentType="text/html"
                                throwsException="false"
                        ><![CDATA[
                                <html>
                                <head>
                                <title>[ERROR] GDX_GD_7840J_refresh_discnt_apc_rpt.xml</title>
                                </head>
                                <body>

                                <h3><u>[ERROR] GDX_GD_7840J_refresh_discnt_apc_rpt.xml</u></h3>

                                <table cellpadding="2">
                                        <tr><td><b>Host:</b></td><td>${localhost}<td></tr>
                                        <tr><td><b>Started:</b></td><td>${startTime}<td></tr>
                                        <tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
                                        #if (${system.getProperty('logfile')})
                                                <tr>
                                                        <td><b>Log File:</b></td>
                                                        <td>
                                                                ${system.getProperty('logfile')}
                                                        <td>
                                                </tr>
                                        #end
                                </table>

                                <br>
                                <br>
                                #if (${script.getLastStatement()})
                                        <h3><u>Last Statement</u></h3>
                                        <font style="color: blue; font-size: small">
                                        ${script.getLastStatement()}
                                        </font>

                                        <br>
                                        <br>
                                #end

                                <h3><u>Stack Trace</u></h3>
                                <pre style="color: red; font-size: small;">${stackTrace}</pre>
                                </body>
                                </html>
                        ]]></command>
                </catch>
        </command>
</sqml>

		
