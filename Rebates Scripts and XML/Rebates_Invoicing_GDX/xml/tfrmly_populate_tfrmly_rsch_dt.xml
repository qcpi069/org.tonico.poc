
<!-- This xml will load data from the vrap.tfrmly_rsch_dt table on GDX into the mstrgyint.formulary_date table on the EDW
     Datasource definition file datasource.xml is in the ./java/Common_java_db_interface/conf.
     Input Parameters: N/A
		   
     Maestro Command to execute: ./scripts/Common_java_db_interface.ksh tfrmly_populate_tfrmly_rsch_dt.xml

-->
<sqml>
	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->

	<datasources resource="datasource.xml"/>
	
	<!--
		Set-up a try block to send an email on exception.	
	-->         
	<command type="try">
	<try>	

		<!-- This is step 1 to truncate the mstrgyint.formulary_date table-->
		<command type="run" datasource="mstrgy" transaction="true"><![CDATA[
		      
		TRUNCATE TABLE mstrgyint.formulary_date
		
		]]></command>
		
<!-- This is step 2 to set the dates on the vrap.tfrmly_rsch_dt table-->
		<command type="run" datasource="gdxdb" transaction="true"><![CDATA[
		      
		update vrap.tfrmly_rsch_dt 
		set 
		     (CUR_DT,
			 CURQTR_3_LST_DT,
			 CURQTR_3_1ST_DT,
			 CURQTR_2_MID_DT,
			 CURQTR_2_1ST_DT,
			 CURQTR_1_1ST_DT,
			 RLTVQTR1_3_LST_DT,
			 RLTVQTR1_3_1ST_DT,
			 RLTVQTR1_2_MID_DT,
			 RLTVQTR1_2_1ST_DT,
			 RLTVQTR1_1_1ST_DT,
			 RLTVQTR2_3_LST_DT,
			 RLTVQTR2_3_1ST_DT,
			 RLTVQTR2_2_MID_DT,
			 RLTVQTR2_2_1ST_DT,
			 RLTVQTR2_1_1ST_DT,
			 RLTVQTR3_3_1ST_DT,
			 RLTVQTR3_3_LST_DT,
			 RLTVQTR3_2_MID_DT,
			 RLTVQTR3_2_1ST_DT,
			 RLTVQTR3_1_1ST_DT,
			 RLTVQTR4_3_LST_DT,
			 RLTVQTR4_3_1ST_DT,
			 RLTVQTR4_2_MID_DT,
			 RLTVQTR4_2_1ST_DT,
			 RLTVQTR4_1_1ST_DT) = 
		 (select cur_dt
		, min(case when rn = 1 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) curqtr_3_Lst_dt 
		, min(case when rn = 2 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) curqtr_3_1st_dt 
		, min(case when rn = 3 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) curqtr_2_mid_dt 
		, min(case when rn = 4 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) curqtr_2_1st_dt 
		, min(case when rn = 5 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) curqtr_1_1st_dt 
		, min(case when rn = 6 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr1_3_Lst_dt 
		, min(case when rn = 7 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr1_3_1st_dt 
		, min(case when rn = 8 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr1_2_mid_dt
		, min(case when rn = 9 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr1_2_1st_dt 
		, min(case when rn = 10 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr1_1_1st_dt 
		, min(case when rn = 11 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr2_3_Lst_dt 
		, min(case when rn = 12 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr2_3_1st_dt 
		, min(case when rn = 13 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr2_2_mid_dt
		, min(case when rn = 14 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr2_2_1st_dt 
		, min(case when rn = 15 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr2_1_1st_dt
		, min(case when rn = 16 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr3_3_Lst_dt 
		, min(case when rn = 17 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr3_3_1st_dt 
		, min(case when rn = 18 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr3_2_mid_dt
		, min(case when rn = 19 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr3_2_1st_dt 
		, min(case when rn = 20 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr3_1_1st_dt
		, min(case when rn = 21 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr4_3_Lst_dt 
		, min(case when rn = 22 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr4_3_1st_dt 
		, min(case when rn = 23 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr4_2_mid_dt
		, min(case when rn = 24 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr4_2_1st_dt 
		, min(case when rn = 25 then SUBSTR(run_dt,1,2)||'/'||SUBSTR(run_dt,3,2)||'/'||SUBSTR(run_dt,5,4) end) rltvqtr4_1_1st_dt   
		from  
		(
		SELECT a.RUN_DT
		, row_number() over(ORDER BY a.QTR_YYYY DESC, a.QTR_QQ DESC,  a.RUN_DT DESC ) AS RN
		, hdr_mm||'/'||hdr_dd||'/'||hdr_yyyy AS cur_dt
		 FROM vrap.trfra_prd_cntl a,
		      vrap.trfra_rsp_hdr 
		 WHERE (a.QTR_YYYY||a.QTR_QQ) <= 
		     (SELECT MIN(b.QTR_YYYY||b.QTR_QQ)
				   FROM vrap.trfra_prd_CNTL b
				   WHERE b.RUN_STAT_CD = 'N'
				   )
		  ) ts
		WHERE ts.RN <= 25
		GROUP BY cur_dt)

		
		]]></command>		
		<!-- This is step 3 to select the data from the vrap.tfrmly_rsch_dt table-->
		
		<command type="copy" batch="500">
			<source type="sql" datasource="gdxdb"><![CDATA[
			
			SELECT
			t.CUR_DT,
			t.CURQTR_3_LST_DT,
			t.CURQTR_3_1ST_DT,
			t.CURQTR_2_MID_DT,
			t.CURQTR_2_1ST_DT,
			t.CURQTR_1_1ST_DT,
			t.RLTVQTR1_3_LST_DT,
			t.RLTVQTR1_3_1ST_DT,
			t.RLTVQTR1_2_MID_DT,
			t.RLTVQTR1_2_1ST_DT,
			t.RLTVQTR1_1_1ST_DT,
			t.RLTVQTR2_3_LST_DT,
			t.RLTVQTR2_3_1ST_DT,
			t.RLTVQTR2_2_MID_DT,
			t.RLTVQTR2_2_1ST_DT,
			t.RLTVQTR2_1_1ST_DT,
			t.RLTVQTR3_3_1ST_DT,
			t.RLTVQTR3_3_LST_DT,
			t.RLTVQTR3_2_MID_DT,
			t.RLTVQTR3_2_1ST_DT,
			t.RLTVQTR3_1_1ST_DT,
			t.RLTVQTR4_3_LST_DT,
			t.RLTVQTR4_3_1ST_DT,
			t.RLTVQTR4_2_MID_DT,
			t.RLTVQTR4_2_1ST_DT,
			t.RLTVQTR4_1_1ST_DT
			FROM VRAP.TFRMLY_RSCH_DT t
			
		 ]]></source>	
				

			<target
				type        = "queue"
				threadCount = "1">
			

				<target
					type           = "sql"
					datasource     = "mstrgy"
					transaction    = "true"
					batch          = "500"
					reportInterval = "50000"
					queryTimeout   = "${TIMEOUT}"
				><![CDATA[
				
			INSERT into mstrgyint.formulary_date
			    (current_date                   
			    ,current_qtr_last                
			    ,current_qtr_lastfirst           
			    ,current_qtr_mid                 
			    ,current_qtr_midfirst            
			    ,current_qtr_first               
			    ,one_qtr_ago_last                
			    ,one_qtr_ago_lastfirst           
			    ,one_qtr_ago_midfirst            
			    ,one_qtr_ago_mid                 
			    ,one_qtr_ago_first               
			    ,two_qtrs_ago_last               
			    ,two_qtrs_ago_lastfirst          
			    ,two_qtrs_ago_mid                
			    ,two_qtrs_ago_midfirst           
			    ,two_qtrs_ago_first              
			    ,three_qtrs_ago_last             
			    ,three_qtrs_ago_lastfirst        
			    ,three_qtrs_ago_mid              
			    ,three_qtrs_ago_midfirst         
			    ,three_qtrs_ago_first            
			    ,four_qtrs_ago_last              
			    ,four_qtrs_ago_lastfirst         
			    ,four_qtrs_ago_mid               
			    ,four_qtrs_ago_midfirst          
			    ,four_qtrs_ago_first)                
			VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?, ?, ?,
			        ?, ?,?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
				
				]]></target>
			  </target>
			</command>
				
		<!-- This is step 4 to update the status code on the vrap.trfra_prd_cntl table-->
		<command type="run" datasource="gdxdb" transaction="true"><![CDATA[
		      
		update vrap.trfra_prd_cntl t
			set t.RUN_STAT_CD = 'P'
			where t.RUN_DT = (
				select h.HDR_MM||h.HDR_DD||h.HDR_YYYY
				from vrap.trfra_rsp_hdr h) 
		
		]]></command>
		</try>
	<catch>

	<!-- Send an email on error -->
		<command
			type="mail"
			mailTo="${email_address}"
			mailFrom="populate_tfrmly_rsch_dt@caremark.com"
			subject="[${region}] [ERROR] Load to mstrgyint.formulary_date table"
			contentType="text/html"
			throwsException="false"
		><![CDATA[
			<html>
			<head>
			<title>[ERROR] Load to MSTRGYINT.FORMULARY_DATE table</title>
			</head>
			<body>

			<h3><u>[ERROR] Load to MSTRGYINT.FORMULARY_DATE table</u></h3>

			<table cellpadding="2">
				<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
				<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
				<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
				#if (${system.getProperty('logfile')})
					<tr>
						<td><b>Log File:</b></td>
						<td>
							${system.getProperty('logfile')}
						<td>
					</tr>
				#end
			</table>

			<br>			
			<br>

			#if (${script.getLastStatement()})
				<h3><u>Last Statement</u></h3>
				<font style="color: blue; font-size: small">	
				${script.getLastStatement()}
				</font>

				<br>
				<br>
			#end

			<h3><u>Stack Trace</u></h3>		
			<pre style="color: red; font-size: small;">${stackTrace}</pre>
			</body>
			</html>
		]]></command>

	</catch>
	</command>
</sqml>
