
<!-- This xml will select claims from the vrap.trxmax_duplicate_claims table. It will then format a GDX and RxMax version of
        the claim and insert them into the VRAP.TAPC_DUP_CLAIMS table

     Datasource definition file datasource.xml is in the ./java/Common_java_db_interface/conf.

     Maestro Command to execute xml: ./scripts/Common_java_db_interface.ksh GDX_build_apc_dup_claims_rxmax.xml

-->
<sqml>

	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->

	<datasources resource="datasource.xml"/>

	<!--
		Set-up a try block to send an email on exception.
	-->
	<command type="try">
	<try>

			<!-- Query DB for current processing quarter info -->
			<command type="run" datasource="gdxdb" rowName="inv_qtr"><![CDATA[
				SELECT CAST(quarter_id AS char(6)), CHAR(period_begin_dt,usa), CHAR(period_end_dt,usa)
				  FROM VRAP.TDISCNT_PERIOD
				 WHERE QUARTER_ID = (SELECT QUARTER_ID FROM VRAP.TCUR_INV_PRD)
				  AND PERIOD_ID like 'Q%'

			]]></command>
			<!-- Command to set quarter parameters-->
			<command type="java"><![CDATA[
				 String  qtrBeginDate ="";
				 String  qtrEndDate ="";
				 String  qtrId ="";

		    	         qtrId = script.getProperty("inv_qtr.1");
				 qtrBeginDate = script.getProperty("inv_qtr.2");
				 qtrEndDate   = script.getProperty("inv_qtr.3");

				 if (qtrId==null || qtrId.trim().length()==0 ||
				    qtrBeginDate==null || qtrBeginDate.trim().length()==0 ||
				    qtrEndDate==null || qtrEndDate.trim().length()==0)
				{
			  	 throw new Exception("Processing Cycle Info not found ");
				}
				//Make the variables available to other queries below
				 script.setProperty("qtrId",qtrId);
				 script.setProperty("qtrBeginDate",qtrBeginDate);
				 script.setProperty("qtrEndDate",qtrEndDate);

			]]></command>

        <!-- delete existing rows within GDX  -->
        <command type="run" datasource="gdxdb" transaction="false"><![CDATA[

                 DELETE
                   FROM VRAP.TAPC_DUP_CLAIMS
                  WHERE QUARTER_ID = ${qtrId}
                    and CLAIM_ID IN (SELECT CLAIM_ID
                                        from vrap.tapc_dup_claims
                                        where quarter_id = ${qtrId}
                                        and   model_typ_cd = 'R')

        ]]></command>

		<!-- Now check for duplicate invoiced claims GPO model -->

		<command type="copy" batch="500">
			<source type="sql" datasource="gdxdb"><![CDATA[

			 SELECT
			 a.QUARTER_ID
			,a.CLAIM_ID
			,a.MODEL_TYP_CD
			,a.HVST_ID
			,a.ALLW_IN_APC
			FROM ( SELECT
			      ${qtrId} AS QUARTER_ID
			     ,CLAIM_ID
			     ,'R' as MODEL_TYP_CD
			     ,CAST(NULL as INT) as HVST_ID
			     ,CAST(NULL as VARCHAR(1))as ALLW_IN_APC
			     FROM VRAP.TRXMAX_DUPLICATE_CLAIMS
			  UNION All
			      SELECT
			      ${qtrId} AS QUARTER_ID
			     ,CLAIM_ID
			     ,MODEL_TYP_CD
			     ,HVST_ID
			     ,CAST(NULL as VARCHAR(1)) as ALLW_IN_APC
			     FROM VRAP.TRXMAX_DUPLICATE_CLAIMS g
			     ) a

			  WITH UR

			]]></source>


			<target
				type        = "queue"
				threadCount = "5">


				<target
					type           = "sql"
					datasource     = "gdxdb"
					transaction    = "true"
					batch          = "500"
					reportInterval = "50000"
					queryTimeout   = "${TIMEOUT}"
				><![CDATA[

				INSERT INTO VRAP.TAPC_DUP_CLAIMS
					(QUARTER_ID,
					 CLAIM_ID,
					 MODEL_TYP_CD,
					 HVST_ID,
					 ALLW_IN_APC)
				VALUES (?, ?, ?, ?, ?)

				]]></target>
			 </target>
		</command>
	</try>
	<catch>

	<!-- Send an email on error -->
		<command
			type="mail"
			mailTo="${email_address}"
			mailFrom="GDX_build_apc_dup_claims_rxmax.xml@caremark.com"
			subject="[${region}] [ERROR] Load to VRAP.TAPC_DUP_CLAIMS table"
			contentType="text/html"
			throwsException="false"
		><![CDATA[
			<html>
			<head>
			<title>[ERROR]  </title>
			</head>
			<body>

			<h3><u>[ERROR] Load to VRAP.TAPC_DUP_CLAIMS table</u></h3>

			<table cellpadding="2">
				<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
				<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
				<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
				#if (${system.getProperty('logfile')})
					<tr>
						<td><b>Log File:</b></td>
						<td>
							${system.getProperty('logfile')}
						<td>
					</tr>
				#end
			</table>

			<br>
			<br>

			#if (${script.getLastStatement()})
				<h3><u>Last Statement</u></h3>
				<font style="color: blue; font-size: small">
				${script.getLastStatement()}
				</font>

				<br>
				<br>
			#end

			<h3><u>Stack Trace</u></h3>
			<pre style="color: red; font-size: small;">${stackTrace}</pre>
			</body>
			</html>
		]]></command>

	</catch>
	</command>
</sqml>
