
<!-- This xml will load data from the dwcorp.t_prctr_denorm table on the EDW and insert it into the vrap.TPRCTR_DENORM_STAGE table on GDX
     Datasource definition file datasource.xml is under the ./java/Common_java_db_interface/conf
  
     Input Parameters: N/A
		   
     Maestro Command to execute: ./scripts/Common_java_db_interface.ksh GDX_prctr_xref_load.xml

-->
<sqml>
	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->

	<datasources resource="datasource.xml"/>
	
	<!--
		Set-up a try block to send an email on exception.	
	-->         
	<command type="try">
	<try>	

				
		<!-- This is step 1 to select the data from the vrap.tfrmly_rsch table-->
		
		<command type="copy" batch="500">
			<source type="sql" datasource="edwdb"><![CDATA[
			SELECT /*+ full(a) parallel(a,5) */
				 a.prctr_gid
				,SUBSTR(a.prctr_id,1,9)
				,SUBSTR(a.prctr_npi_id,1,10)
			 FROM dwcorp.t_prctr_denorm a
			WHERE a.prctr_id_typ_cd = 'DH'
			  AND LENGTH(a.prctr_id) = 9
			]]></source>	
				
			<target
				type        = "queue"
				threadCount = "5">
			        <target
					type           = "sql"
					datasource     = "gdxdb"
					transaction    = "true"
					batch          = "500"
					reportInterval = "50000"
					queryTimeout   = "${TIMEOUT}"
				><![CDATA[
				
			INSERT into vrap.TPRCTR_DENORM_STAGE
			    (PRCTR_GID
			    ,PRCTR_DEA_ID
			    ,PRCTR_NPI_ID) 
			    VALUES (?, ?, ?) 				
			    	]]></target>
			</target> 
		</command>
		
	</try>
	<catch>

	<!-- Send an email on error -->
		<command
			type="mail"
			mailTo="nick.tucker@caremark.com"  
			mailFrom="GDX_prctr_xref_load@caremark.com"
			subject="[${region}] [ERROR] Load to vrap.TPRCTR_XREF_STAGE table"
			contentType="text/html"
			throwsException="false"
		><![CDATA[
			<html>
			<head>
			<title>[ERROR] Load to vrap.TPRCTR_XREF_STAGE </title>
			</head>
			<body>

			<h3><u>[ERROR] Load to vrap.TPRCTR_XREF_STAGE table</u></h3>

			<table cellpadding="2">
				<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
				<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
				<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
				#if (${system.getProperty('logfile')})
					<tr>
						<td><b>Log File:</b></td>
						<td>
							${system.getProperty('logfile')}
						<td>
					</tr>
				#end
			</table>

			<br>			
			<br>

			#if (${script.getLastStatement()})
				<h3><u>Last Statement</u></h3>
				<font style="color: blue; font-size: small">	
				${script.getLastStatement()}
				</font>

				<br>
				<br>
			#end

			<h3><u>Stack Trace</u></h3>		
			<pre style="color: red; font-size: small;">${stackTrace}</pre>
			</body>
			</html>
		]]></command>

	</catch>
	</command>
</sqml>
