<!--
     Loads PharmaCare formulary data into the VRAP.TFORMULARY_CONSOLIDATED from V_FRMLY_ALL
     This is executed in Unix scripts: GDX_GDDY0010_GD_0010J_tformulary_consolidated_load.ksh
  
     The XML file should reside under ./xml directory
     Maestro Command with parameter: ./scripts/Common_java_db_interface.ksh <xml file name>

     Date        ID         Number    Description 
     ********    *******    ******    ********************************************************* 
     01-18-09    qcpi08a    42269     Added 'R' formulary source code for RxAmerica Integration
     ********    *******    ******    *********************************************************

-->
<sqml>
        <property name="TIMEOUT" value="0"/>
        <!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->
        <datasources resource="datasource.xml"/>

        <!-- Set-up a try block to send an email on exception.  -->
        <command type="try">
        <try>
		<!-- Insert into tformulary_consolidated in GDX from silver  -->
		<command type="copy" batch="500">
			 <source type="sql" datasource="silver"><![CDATA[

				 SELECT
                                        FRMLY_EXTNL_ID
					,FRMLY_SRC_CD
                                        ,FRMLY_NME
					,EFF_DATE
					,END_DATE
				   FROM DMA_RBATE2.V_FRMLY_ALL 
				  WHERE FRMLY_SRC_CD IN ('P', 'R')

		 	]]></source>
		 	<target
				type           = "sql"
				datasource     = "gdxdb"
				transaction    = "true"
				batch          = "500"
				reportInterval = "5000"
				queryTimeout   = "${TIMEOUT}"
			 ><![CDATA[

				 INSERT 
                                   INTO VRAP.TFORMULARY_CONSOLIDATED (
				        FRMLY_ID
                                        , FRMLY_SRC_CD
                                        , FORMULARY_NM
                                        , EFF_DT
                                        , END_DT
					)
				 VALUES (?, ?, ?, ?, ?)

		 	]]></target>
     	      </command>
	</try>
              <catch>
                        <!-- Send an email on error -->
                        <command
                                type="mail"
                                mailTo="${email_address}"
                                mailFrom="PHC_tformulary_consolidated_load@caremark.com"
                                subject="[ERROR] GDX_GD_0010J_tformulary_consolidated_load_phc.xml "
                                contentType="text/html"
                                throwsException="false"
                        ><![CDATA[
                                <html>
                                <head>
                                <title>[ERROR] GDX_GD_0010J_tformulary_consolidated_load_phc.xml </title>
                                </head>
                                <body>

                                <h3><u>[ERROR] GDX_GD_0010J_tformulary_consolidated_load_phc.xml </u></h3>

                                <table cellpadding="2">
                                        <tr><td><b>Host:</b></td><td>${localhost}<td></tr>
                                        <tr><td><b>Started:</b></td><td>${startTime}<td></tr>
                                        <tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
                                        #if (${system.getProperty('logfile')})
                                                <tr>
                                                        <td><b>Log File:</b></td>
                                                        <td>
                                                                ${system.getProperty('logfile')}
                                                        <td>
                                                </tr>
                                        #end
                                </table>

                                <br>
                                <br>
                                #if (${script.getLastStatement()})
                                        <h3><u>Last Statement</u></h3>
                                        <font style="color: blue; font-size: small">
                                        ${script.getLastStatement()}
                                        </font>

                                        <br>
                                        <br>
                                #end

                                <h3><u>Stack Trace</u></h3>
                                <pre style="color: red; font-size: small;">${stackTrace}</pre>
                                </body>
                                </html>
                        ]]></command>
                </catch>
        </command>
</sqml>
 
