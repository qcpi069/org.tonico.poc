
<!-- This xml will load data from the VRAP.TRFRA_SUM table to the VRAP.TFRMLY_RSCH table on GDX 
     
     Datasource definition file datasource.xml is in the ./java/Common_java_db_interface/conf.
     Input Parameters: N/A
		   
     Maestro Command to execute: ./scripts/Common_java_db_interface.ksh tfrmly_rsch_populate.xml

-->
<sqml>
	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->

	<datasources resource="datasource.xml"/>
	
	<!--
		Set-up a try block to send an email on exception.	
	-->         
	<command type="try">
	<try>		
		
				
		<!-- This is step 1 to select the key fields from vrap.trfra_sum table and insert them into the vrap.tfrmly_rsch table-->
		
		<command type="copy" batch="500">
			<source type="sql" datasource="gdxdb"><![CDATA[
			
			     select
			     	 FRMLY_SRC_CD,
				 FRMLY_ID,
				 RTRIM(BRND_DRUG_NM),
				 RBAT_PREF_STAT_CD,
				 MSG_NB,
				 MSG_TXT,
				 COALESCE(CURQTR_3_LST_CNT,'0'),
				 COALESCE(CURQTR_3_1ST_CNT,'0'),
			 	 COALESCE(CURQTR_2_MID_CNT,'0'),
				 COALESCE(CURQTR_2_1ST_CNT,'0'),
				 COALESCE(CURQTR_1_1ST_CNT,'0'),
				 COALESCE(RLTVQTR1_3_LST_CNT,'0'),
				 COALESCE(RLTVQTR1_3_1ST_CNT,'0'),
				 COALESCE(RLTVQTR1_2_MID_CNT,'0'),
				 COALESCE(RLTVQTR1_2_1ST_CNT,'0'),
				 COALESCE(RLTVQTR1_1_1ST_CNT,'0'),
				 COALESCE(RLTVQTR2_3_LST_CNT,'0'),
				 COALESCE(RLTVQTR2_3_1ST_CNT,'0'),
				 COALESCE(RLTVQTR2_2_MID_CNT,'0'),
				 COALESCE(RLTVQTR2_2_1ST_CNT,'0'),
				 COALESCE(RLTVQTR2_1_1ST_CNT,'0'),
				 COALESCE(RLTVQTR3_3_LST_CNT,'0'),
				 COALESCE(RLTVQTR3_3_1ST_CNT,'0'),
				 COALESCE(RLTVQTR3_2_MID_CNT,'0'),
				 COALESCE(RLTVQTR3_2_1ST_CNT,'0'),
				 COALESCE(RLTVQTR3_1_1ST_CNT,'0'),
				 COALESCE(RLTVQTR4_3_LST_CNT,'0'),
				 COALESCE(RLTVQTR4_3_1ST_CNT,'0'),
				 COALESCE(RLTVQTR4_2_MID_CNT,'0'),
				 COALESCE(RLTVQTR4_2_1ST_CNT,'0'),
				 COALESCE(RLTVQTR4_1_1ST_CNT,'0'),
				 DUM_MSG_CD,
				 FRMLY_PRCS_CD,
				 FRMLY_CLOS_TYP_CD,
				 FRMLY_DRUG_STAT_CD,
				 LOCK_CD  
				 from (
			 SELECT 
			     FRMLY_SRC_CD
			    ,FRMLY_ID
			    ,BRND_DRUG_NM
			    ,RBAT_PREF_STAT_CD
			    ,MSG_NB
			    ,MSG_TXT
			    ,min(case when rn = 1 then char(COALESCE(ndc_cnt,0)) end) curqtr_3_Lst_cnt 
			    ,min(case when rn = 2 then char(COALESCE(ndc_cnt,0)) end) curqtr_3_1st_cnt 
			    ,min(case when rn = 3 then char(COALESCE(ndc_cnt,0)) end) curqtr_2_mid_cnt 
			    ,min(case when rn = 4 then char(COALESCE(ndc_cnt,0)) end) curqtr_2_1st_cnt 
			    ,min(case when rn = 5 then char(COALESCE(ndc_cnt,0)) end) curqtr_1_1st_cnt 
			    ,min(case when rn = 6 then char(COALESCE(ndc_cnt,0)) end) rltvqtr1_3_Lst_cnt 
			    ,min(case when rn = 7 then char(COALESCE(ndc_cnt,0)) end) rltvqtr1_3_1st_cnt 
			    ,min(case when rn = 8 then char(COALESCE(ndc_cnt,0)) end) rltvqtr1_2_mid_cnt
			    ,min(case when rn = 9 then char(COALESCE(ndc_cnt,0)) end) rltvqtr1_2_1st_cnt 
			    ,min(case when rn = 10 then char(COALESCE(ndc_cnt,0)) end) rltvqtr1_1_1st_cnt 
			    ,min(case when rn = 11 then char(COALESCE(ndc_cnt,0)) end) rltvqtr2_3_Lst_cnt 
			    ,min(case when rn = 12 then char(COALESCE(ndc_cnt,0)) end) rltvqtr2_3_1st_cnt 
			    ,min(case when rn = 13 then char(COALESCE(ndc_cnt,0)) end) rltvqtr2_2_mid_cnt
			    ,min(case when rn = 14 then char(COALESCE(ndc_cnt,0)) end) rltvqtr2_2_1st_cnt 
			    ,min(case when rn = 15 then char(COALESCE(ndc_cnt,0)) end) rltvqtr2_1_1st_cnt
			    ,min(case when rn = 16 then char(COALESCE(ndc_cnt,0)) end) rltvqtr3_3_Lst_cnt 
			    ,min(case when rn = 17 then char(COALESCE(ndc_cnt,0)) end) rltvqtr3_3_1st_cnt 
			    ,min(case when rn = 18 then char(COALESCE(ndc_cnt,0)) end) rltvqtr3_2_mid_cnt
			    ,min(case when rn = 19 then char(COALESCE(ndc_cnt,0)) end) rltvqtr3_2_1st_cnt 
			    ,min(case when rn = 20 then char(COALESCE(ndc_cnt,0)) end) rltvqtr3_1_1st_cnt
			    ,min(case when rn = 21 then char(COALESCE(ndc_cnt,0)) end) rltvqtr4_3_Lst_cnt 
			    ,min(case when rn = 22 then char(COALESCE(ndc_cnt,0)) end) rltvqtr4_3_1st_cnt 
			    ,min(case when rn = 23 then char(COALESCE(ndc_cnt,0)) end) rltvqtr4_2_mid_cnt
			    ,min(case when rn = 24 then char(COALESCE(ndc_cnt,0)) end) rltvqtr4_2_1st_cnt 
			    ,min(case when rn = 25 then char(COALESCE(ndc_cnt,0)) end) rltvqtr4_1_1st_cnt
			    ,DUM_MSG_CD
			    ,FRMLY_PRCS_CD
			    ,FRMLY_CLOS_TYP_CD
			    ,FRMLY_DRUG_STAT_CD
			    ,LOCK_CD   
			  FROM
				(
				SELECT
				t.FRMLY_SRC_CD
				,t.FRMLY_ID
				,t.BRND_DRUG_NM
				,t.RBAT_PREF_STAT_CD
				,t.MSG_NB
				,t.MSG_TXT
				,t.DUM_MSG_CD
				,t.FRMLY_PRCS_CD
				,t.FRMLY_CLOS_TYP_CD
				,t.FRMLY_DRUG_STAT_CD
				,t.LOCK_CD
				,t.NDC_CNT
				,ts.RN
					FROM VRAP.TRFRA_SUM t,
					 ( SELECT a.QTR_YYYY, a.QTR_QQ, a.RUN_DT, a.RUN_SEQ_NB
				       , row_number() over(ORDER BY a.QTR_YYYY DESC,a.QTR_QQ DESC,a.RUN_DT DESC) AS RN
						FROM vrap.trfra_prd_cntl a
						WHERE (a.QTR_YYYY||a.QTR_QQ) <= 
						     (SELECT MIN(b.QTR_YYYY||b.QTR_QQ)
							FROM vrap.trfra_prd_cntl b
						       WHERE b.RUN_STAT_CD = 'N')
				     ) ts       
					WHERE ts.RN <= 25
					  AND t.run_dt = ts.run_dt
				      )x	
			  GROUP BY
				 FRMLY_SRC_CD
				,FRMLY_ID
				,BRND_DRUG_NM
				,RBAT_PREF_STAT_CD
				,MSG_NB
				,MSG_TXT
				,DUM_MSG_CD
				,FRMLY_PRCS_CD
				,FRMLY_CLOS_TYP_CD
				,FRMLY_DRUG_STAT_CD
				,LOCK_CD)y
			
			]]></source>	
				

			<target
				type        = "queue"
				threadCount = "5">
			

				<target
					type           = "sql"
					datasource     = "gdxdb"
					transaction    = "true"
					batch          = "500"
					reportInterval = "50000"
					queryTimeout   = "${TIMEOUT}"
				><![CDATA[
				
			INSERT INTO VRAP.TFRMLY_RSCH
				(FRMLY_SRC_CD,
				 FRMLY_ID,
				 BRND_DRUG_NM,
				 RBAT_PREF_STAT_CD,
				 MSG_NB,
				 MSG_TXT,
				 CURQTR_3_LST_CNT,
				 CURQTR_3_1ST_CNT,
				 CURQTR_2_MID_CNT,
				 CURQTR_2_1ST_CNT,
				 CURQTR_1_1ST_CNT,
				 RLTVQTR1_3_LST_CNT,
				 RLTVQTR1_3_1ST_CNT,
				 RLTVQTR1_2_MID_CNT,
				 RLTVQTR1_2_1ST_CNT,
				 RLTVQTR1_1_1ST_CNT,
				 RLTVQTR2_3_LST_CNT,
				 RLTVQTR2_3_1ST_CNT,
				 RLTVQTR2_2_MID_CNT,
				 RLTVQTR2_2_1ST_CNT,
				 RLTVQTR2_1_1ST_CNT,
				 RLTVQTR3_3_LST_CNT,
				 RLTVQTR3_3_1ST_CNT,
				 RLTVQTR3_2_MID_CNT,
				 RLTVQTR3_2_1ST_CNT,
				 RLTVQTR3_1_1ST_CNT,
				 RLTVQTR4_3_LST_CNT,
				 RLTVQTR4_3_1ST_CNT,
				 RLTVQTR4_2_MID_CNT,
				 RLTVQTR4_2_1ST_CNT,
				 RLTVQTR4_1_1ST_CNT,
				 DUM_MSG_CD,
				 FRMLY_PRCS_CD,
				 FRMLY_CLOS_TYP_CD,
				 FRMLY_DRUG_STAT_CD,
				 LOCK_CD)
			VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
				
				]]></target>
			 </target> 
		</command>
		
	</try>
	<catch>

	<!-- Send an email on error -->
		<command
			type="mail"
			mailTo="${email_address}"
			mailFrom="tfrmly_rsch_populate@caremark.com"
			subject="[${region}] [ERROR] Load to VRAP.TFRMLY_RSCH table"
			contentType="text/html"
			throwsException="false"
		><![CDATA[
			<html>
			<head>
			<title>[ERROR] Load to VRAP.TFRMLY_RSCH table</title>
			</head>
			<body>

			<h3><u>[ERROR] Load to VRAP.TFRMLY_RSCH table</u></h3>

			<table cellpadding="2">
				<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
				<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
				<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
				#if (${system.getProperty('logfile')})
					<tr>
						<td><b>Log File:</b></td>
						<td>
							${system.getProperty('logfile')}
						<td>
					</tr>
				#end
			</table>

			<br>			
			<br>

			#if (${script.getLastStatement()})
				<h3><u>Last Statement</u></h3>
				<font style="color: blue; font-size: small">	
				${script.getLastStatement()}
				</font>

				<br>
				<br>
			#end

			<h3><u>Stack Trace</u></h3>		
			<pre style="color: red; font-size: small;">${stackTrace}</pre>
			</body>
			</html>
		]]></command>

	</catch>
	</command>
</sqml>
