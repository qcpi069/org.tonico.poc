
<!-- This xml will delete data older than 30 periods from the vrap.trfra_sum table on GDX. 
     Input Parameters: N/A
		   
     Maestro Command to execute: ./scripts/Common_java_db_interface.ksh tfrmly_delete_old_sum_data.xml
-->
<sqml>
	
	<property name="TIMEOUT" value="0"/>
	<!-- datasource.xml defines DB connection info. It should be under ./java/Common_java_db_interface/conf-->

	<datasources resource="datasource.xml"/>
	
	<!--
		Set-up a try block to send an email on exception.	
	-->         
	<command type="try">
	<try>	

		<!-- This is step 1 to delete rows greater than 30 date periods from the vrap.trfra_sum table-->
		<command type="run" datasource="gdxdb" transaction="true"><![CDATA[
		      
		DELETE FROM VRAP.TRFRA_SUM t
		    WHERE t.QTR_YYYY||t.QTR_QQ||t.RUN_DT IN 
			 ( 
			 SELECT QTR_YYYY||QTR_QQ||RUN_DT
			   FROM 
			   (SELECT a.QTR_YYYY, a.QTR_QQ, a.RUN_DT
				   ,row_number() over(ORDER BY a.QTR_YYYY DESC,a.QTR_QQ DESC,a.RUN_DT DESC) AS RN
				   FROM vrap.trfra_prd_cntl a
				  WHERE  (a.QTR_YYYY||a.QTR_QQ) <=
				    (SELECT MAX(b.QTR_YYYY||b.QTR_QQ)
				       FROM vrap.trfra_prd_cntl b
				      WHERE b.RUN_STAT_CD = 'P')
				     )TS 
				WHERE TS.RN > 30 )
		
		]]></command>
		</try>
	<catch>

	<!-- Send an email on error -->
		<command
			type="mail"
			mailTo="${email_address}"
			mailFrom="delete_old_sum_data@caremark.com"
			subject="[${region}] [ERROR] Load to mstrgyint.formulary_date table"
			contentType="text/html"
			throwsException="false"
		><![CDATA[
			<html>
			<head>
			<title>[ERROR] Delete old data from VRAP.TRFRA_SUM table</title>
			</head>
			<body>

			<h3><u>[ERROR] Delete old data from VRAP.TRFRA_SUM table</u></h3>

			<table cellpadding="2">
				<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
				<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
				<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
				#if (${system.getProperty('logfile')})
					<tr>
						<td><b>Log File:</b></td>
						<td>
							${system.getProperty('logfile')}
						<td>
					</tr>
				#end
			</table>

			<br>			
			<br>

			#if (${script.getLastStatement()})
				<h3><u>Last Statement</u></h3>
				<font style="color: blue; font-size: small">	
				${script.getLastStatement()}
				</font>

				<br>
				<br>
			#end

			<h3><u>Stack Trace</u></h3>		
			<pre style="color: red; font-size: small;">${stackTrace}</pre>
			</body>
			</html>
		]]></command>

	</catch>
   </command>
</sqml>
