<sqml>

        <property name="TIMEOUT" value="0"/>
        <datasources resource="datasource.xml"/>

        <!--
                Set-up a try block to send an email on exception.
		call rbate_reg.prc_test_truncate('rbate_reg.tpharm_npi_xref') 
		call rbate_reg.prc_test_truncate('rbate_reg.tpharm_npi_xref') 
		call rbate_reg.pk_util.truncate_table('tpharm_npi_xref','NPI Xref load')
        -->
        <command type="try">
                <try>


	<command type="run" datasource="silver" transaction="false"><![CDATA[
		call rbate_reg.pk_util.truncate_table('tpharm_npi_xref','NPI Xref load')
	]]></command>


	<command type="copy" batch="500">

		<source type="sql" datasource="gdxprd"><![CDATA[
			select PMCY_GID,
       PMCY_BE_ID          ,
       PMCY_NCPDP_ID       ,
       PMCY_NPI_ID         ,
       PMCY_NCPDP_GEN_CD   ,
       PMCY_ST_ABBR_CD     ,
       PMCY_EFF_DT         ,
       PMCY_POST_EFF_DT    ,
       PMCY_TERM_DT        ,
       PMCY_POST_TERM_DT   ,
       ROW_MOD_CD ,
       ROW_ACTV_CD ,
       UPDT_TS             ,
       UPDT_USER_ID        
			 from vrap.tpharm_npi_xref
		]]></source>

		<target
			type           = "sql"
			datasource     = "silver"
			transaction    = "false"
			batch          = "500"
			reportInterval = "500"
			queryTimeout   = "${TIMEOUT}"
		>
Insert into rbate_reg.tpharm_npi_xref (PMCY_GID,
       PMCY_BE_ID          ,
       PMCY_NCPDP_ID       ,
       PMCY_NPI_ID         ,
       PMCY_NCPDP_GEN_CD   ,
       PMCY_ST_ABBR_CD     ,
       PMCY_EFF_DT         ,
       PMCY_POST_EFF_DT    ,
       PMCY_TERM_DT        ,
       PMCY_POST_TERM_DT   ,
       ROW_MOD_CD ,
       ROW_ACTV_CD ,
       UPDT_TS             ,
       UPDT_USER_ID        )
Values (?, ?, ?, ?, ?, ?, ?, ?,?,?,?, ?,?, ?)

		</target>

	</command>

                </try>
                <catch>
                        <!-- Send an email on error -->
                        <command
                                type="mail"
                                mailTo="gdxitd@caremark.com"
                                mailFrom="RPDM_Client_Refresh@caremark.com"
                                subject="[ERROR] REFRESH NPI Xref GDX_NPI_XRef_load.xml"
                                contentType="text/html"
                                throwsException="false"
                        ><![CDATA[
                                <html>
                                <head>
                                <title>[ERROR] REFRESH NPI Xref</title>
                                </head>
                                <body>

                                <h3><u>[ERROR] REFRESH NPI Xref </u></h3>

                                <table cellpadding="2">
                                        <tr><td><b>Host:</b></td><td>${localhost}<td></tr>
                                        <tr><td><b>Started:</b></td><td>${startTime}<td></tr>
                                        <tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
                                        #if (${system.getProperty('logfile')})
                                                <tr>
                                                        <td><b>Log File:</b></td>
                                                        <td>
                                                                ${system.getProperty('logfile')}
                                                        <td>
                                                </tr>
                                        #end
                                </table>

                                <br>
                                <br>

                                #if (${script.getLastStatement()})
                                        <h3><u>Last Statement</u></h3>
                                        <font style="color: blue; font-size: small">
                                        ${script.getLastStatement()}
                                        </font>

                                        <br>
                                        <br>
                                #end

                                <h3><u>Stack Trace</u></h3>
                                <pre style="color: red; font-size: small;">${stackTrace}</pre>
                                </body>
                                </html>
                        ]]></command>
                </catch>
        </command>



</sqml>
