<!-- REFRESH GOLD GDX DRUG info for DFO  -->
 
<sqml>
	<property name="TIMEOUT" value="0"/>
	<datasources resource="datasource_edw.xml"/>
 
	<command type="try">
	    <try>

                 <!-- Truncate the VRAP_TDRUG_PRC_HIS table to prepare for reloading -->
                 <command type="run" datasource="edwdb" transaction="true"><![CDATA[
                       call dma_rbate2.PK_CYCLE_UTIL.TRUNCATE_TABLE('VRAP_TDRUG')
                 ]]></command>

		    <!-- Copy info from GDX to GOLD DMA_RBATE2 -->
		    <command type="copy" batch="2000">
			<source type="sql" datasource="gdxprd"><![CDATA[
			    SELECT t.drug_ndc_id, t.nhu_typ_cd, t.lmt_stblty_cd, t.gpi_grp, t.gpi_cls,
				   t.gpi_sub_cls, t.gpi_nm, t.gpi_ext_nm, t.gpi_form, t.gpi_strgh,
				   t.drug_prod_id, t.ndc5_nb, t.dea_cls_cd, t.rte_of_admin_cd,
				   t.strge_cond_cd, t.dsg_form_cd, t.mtrc_strgh_um_cd, t.drug_pkg_um_cd,
				   t.layout_format_cd, t.unit_dose_cd, t.formly_theracls_cd,
				   t.drug_prc_cls_cd, t.drug_brand_cd, t.genc_ndc_in, t.drug_nm,
				   t.drug_mult_src_in, t.drug_mfr_nm, t.discntu_in, t.drug_ingred_nm,
				   t.alrgy_ptrn_nb, t.drug_pkg_size_qty, t.drug_ptrn_cd, t.rx_in,
				   t.drug_maint_in, t.metric_strgh_qty, t.drug_abbr_prod_nm,
				   t.drug_abbr_dsg_nm, t.drug_abbr_strgh_nm, t.drug_cd_nm, t.drug_desi_in,
				   t.drug_thou_ndc_id, t.drug_hund_ndc_id, t.genc_avail_in,
				   t.theraptc_eqvlt_cd, t.genc_prod_pkg_nb, t.discontu_dt,
				   t.therptc_cls_cd, t.drug_usg_pkg_qty, t.totl_pkg_qty, t.mult_ingred_in,
				   t.ship_strge_cd, t.inv_drug_prc_cls, t.pt_consult_ptrn_cd,
				   t.cts_drug_in, t.reimb_cond_cd, t.labeler_type_cd, t.pricing_spread_cd,
				   t.brand_name_cd, t.mult_src_cd, t.drg_abv_pru_ext_nm,
				   t.drg_abv_stg_ext_nm, t.hsc_ts, t.hsu_ts, t.midrange_update_dt,
				   t.dgh_ext_mnt_in, t.dgh_gcn_cd, t.medispn_rxo_cd, t.prodct_name_ext_tx,
				   t.medispn_pkg_sze_qy, t.medispn_pkg_qy, t.medispn_pkg_dsc_tx,
				   t.medispn_awp_prc_at, t.medispn_awp_eff_dt, t.medispn_wac_prc_at,
				   t.medispn_psu_cd, t.medispn_dsi_cd, t.clinic_pack_in,
				   t.medispn_blk_nm_in, t.medispn_blk_ext_in, t.medispn_blk_abv_in,
				   t.medispn_blk_abe_in, t.medispn_blk_atc_in, t.medispn_blk_brd_in,
				   t.medispn_blk_mul_in, t.medispn_blk_mnt_in, t.medispn_blk_des_in,
				   t.medispn_blk_rx_in, t.medispn_blk_grc_in, t.medispn_blk_cnk_in,
				   t.medicare_d_in, t.third_pty_rstrt_cd, t.package_size_qty,
				   t.gpi_lc10_id, t.ndc_lc11_id, t.ndc_lc9_id, t.ndc_ld9_id,
				   t.gpi_lc10_id_nm, t.ndc_lc11_id_nm, t.ndc_lc9_id_nm
				FROM vrap.tdrug t
			]]></source>
			<target
			    type             = "sql"
			    datasource       = "edwdb"
			    transaction      = "false"
			    batch            = "2000"
			    reportInterval   = "2000"
			    queryTimeout     = "${TIMEOUT}"
			><![CDATA[
			    INSERT INTO dma_rbate2.vrap_tdrug
			    VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,
				     ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
			]]></target>
		    </command>

		</try>
		<catch>
			<!-- Send an email on error -->
			<command
				type="mail"
				mailTo="randy.redus@caremark.com"
				mailFrom="gdxitd@caremark.com"
				subject="[ERROR] refresh_vrap_tdrug_tbls_on_gold - T_DRUG error "
				contentType="text/html"
				throwsException="false"
			><![CDATA[
				<html>
				<head>
				<title>[ERROR] REFRESH CLIENT</title>
				</head>
				<body>
			
				<h3><u>[ERROR] REFRESH CLIENT </u></h3>
			
				<table cellpadding="2">
					<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
					<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
					<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
					#if (${system.getProperty('logfile')})
						<tr>
							<td><b>Log File:</b></td>
							<td>
								${system.getProperty('logfile')}
							<td>
						</tr>
					#end
				</table>

				<br>			
				<br>
				
				#if (${script.getLastStatement()})
					<h3><u>Last Statement</u></h3>
					<font style="color: blue; font-size: small">	
					${script.getLastStatement()}
					</font>
				
					<br>
					<br>
				#end
			
				<h3><u>Stack Trace</u></h3>		
				<pre style="color: red; font-size: small;">${stackTrace}</pre>
				</body>
				</html>
			]]></command>
		</catch>
        </command>

	<command type="try">
	    <try>

   		<!-- Truncate the VRAP_TDRUG_PRC_HIS table to prepare for reloading -->
                    <command type="run" datasource="edwdb" transaction="true"><![CDATA[
				call dma_rbate2.PK_CYCLE_UTIL.TRUNCATE_TABLE('VRAP_TDRUG_PRC_HIS')
		    ]]></command>

		    <!-- Copy info from GDX to GOLD DMA_RBATE2 -->
		    <command type="copy" batch="5000">
			<source type="sql" datasource="gdxprd"><![CDATA[
			    SELECT t.drug_prc_cls_cd, t.drug_prc_src_cd, t.drug_prc_typ_cd, t.drug_ndc_id,
				   t.nhu_typ_cd, t.eff_dt, t.exp_dt, t.drug_prc_amt
				FROM vrap.tdrug_prc_his t
				WHERE DRUG_PRC_CLS_CD = 1
				AND   DRUG_PRC_SRC_CD = 1
				AND   DRUG_PRC_TYP_CD = 1
			]]></source>
			<target
			    type             = "sql"
			    datasource       = "edwdb"
			    transaction      = "false"
			    batch            = "5000"
			    reportInterval   = "5000"
			    queryTimeout     = "${TIMEOUT}"
			><![CDATA[
			    INSERT INTO dma_rbate2.vrap_tdrug_prc_his
			    VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )
			]]></target>
		    </command>

		</try>
		<catch>
			<!-- Send an email on error -->
			<command
				type="mail"
				mailTo="randy.redus@caremark.com"
				mailFrom="gdxitd@caremark.com"
				subject="[ERROR] refresh_vrap_tdrug_tbls_on_gold - T_DRUG_PRC_HIS error "
				contentType="text/html"
				throwsException="false"
			><![CDATA[
				<html>
				<head>
				<title>[ERROR] REFRESH CLIENT</title>
				</head>
				<body>
			
				<h3><u>[ERROR] REFRESH CLIENT </u></h3>
			
				<table cellpadding="2">
					<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
					<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
					<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
					#if (${system.getProperty('logfile')})
						<tr>
							<td><b>Log File:</b></td>
							<td>
								${system.getProperty('logfile')}
							<td>
						</tr>
					#end
				</table>

				<br>			
				<br>
				
				#if (${script.getLastStatement()})
					<h3><u>Last Statement</u></h3>
					<font style="color: blue; font-size: small">	
					${script.getLastStatement()}
					</font>
				
					<br>
					<br>
				#end
			
				<h3><u>Stack Trace</u></h3>		
				<pre style="color: red; font-size: small;">${stackTrace}</pre>
				</body>
				</html>
			]]></command>
		</catch>
        </command>

	
</sqml>
