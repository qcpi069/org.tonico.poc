<sqml>
        <property name="TIMEOUT" value="0"/>
        <datasources resource="datasource.xml"/>
        <properties resource="datamart.properties"/>

    <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        dmt_schema=script.getProperty("dmt_schema");
        ]]></command>

        <command type="try">
                <try>
                        <command type="copy" batch="1000">
                                <source type="sql" datasource="datamart"
                                        ><![CDATA[

  with
inparm (inv_dt, inv_year, inv_qt ) as
(select  case when substr('${INQPARM}',6,1) = '1' then '01/01/' || substr('${INQPARM}',1,4)
                when substr('${INQPARM}',6,1) = '2' then '04/01/' || substr('${INQPARM}',1,4)
                when substr('${INQPARM}',6,1) = '3' then '07/01/' || substr('${INQPARM}',1,4)
                when substr('${INQPARM}',6,1) = '4' then '10/01/' || substr('${INQPARM}',1,4)
        end, substr('${INQPARM}',1,4), substr('${INQPARM}',5,2)
from sysibm.sysdummy1
),


pricing (rac, formula,basis, basis_qual,lcm, rate) as
(select RAC, FORMULA, BASIS, BASIS_QUAL, LCM, rate
from rps.ms_gn_pricing_all s, inparm i
 where i.inv_dt between SPLIT_EFF_DT and SPLIT_TERM_DT
and formula<>'M'
),

cnt(rac,rebate_id,cg,inv_qtr,lcm,rbatRx,subRx,rbatBrand,subBrand ) as
(select RAC_NB, RBAT_ID, CG_NB, INV_CCYY||INV_QTR, SUM_LCM_CD,
   sum(CASE WHEN CLM_CNT_TYP_CD='01' THEN RBAT_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='01' THEN SUBM_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='03' THEN RBAT_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='03' THEN SUBM_CLM_CNT
            ELSE 0 END)
from rps.tapc_lcm_summary c , inparm
where INV_CCYY=inv_year and inv_qtr=inv_qt
group by RAC_NB, RBAT_ID, CG_NB, INV_CCYY||INV_QTR, SUM_LCM_CD
),

cal (rac, rebate_id, inv_qtr, cg, lcm, rate, count ) as
(
(select cnt.rac, cnt.rebate_id, inv_qtr,cg,cnt.lcm, pricing.rate,
        (CASE WHEN pricing.basis='SUBMITTED' THEN
                        (CASE WHEN pricing.basis_qual='BRAND' THEN subBrand
                                ELSE subRx END)
                WHEN pricing.basis='REBATED' THEN
                        (CASE WHEN pricing.basis_qual='BRAND' THEN rbatBrand
                                ELSE rbatRx END)
                WHEN pricing.basis='BRAND' THEN subBrand
                WHEN pricing.basis is null THEN -99999
                ELSE -88888 END) 
 from cnt inner join pricing on (cnt.rac=pricing.rac and cnt.lcm=pricing.lcm)
-- from cnt left outer join pricing on (cnt.rac=pricing.rac and cnt.lcm=pricing.lcm)
where basis_qual<>'NONE'
)
--all tiers count
union all
(
select cnt.rac, cnt.rebate_id, inv_qtr,cg,'0', pricing.rate,
        sum(CASE WHEN pricing.basis='SUBMITTED' THEN subRx
                WHEN pricing.basis='REBATED' THEN rbatRx
                WHEN pricing.basis='BRAND' THEN subBrand
                WHEN pricing.basis is null THEN -99999
                ELSE -88888 END)
from cnt inner join pricing on cnt.rac=pricing.rac
where basis_qual='NONE'
group by cnt.rac, cnt.rebate_id, inv_qtr,cg,'0', pricing.rate
)
--
)
select  inv_year||inv_qt, rebate_id,rac,cg,lcm,rate,count,
	sum(case when f.tran_typ_cd in ('G1','GN') then f.FSMR_AMT * -1 else 0 end) 
	, current date
from cal inner join rps.ksrb223_fesumc f
	on cal.rac=f.RBAT_AFIL_CD and cal.inv_qtr=f.RBAT_BILL_PRD_NM and cal.cg=f.CG_NB
	, inparm
group by inv_year||inv_qt, rebate_id,rac,cg,lcm,rate,count,current date


                                ]]></source>

                                <target
                                        type             = "sql"
                                        datasource       = "datamart"
                                        transaction      = "true"
                                        batch            = "1000"
                                        reportInterval   = "1000"
                                        queryTimeout     = "${TIMEOUT}"
                                ><![CDATA[
                                              insert into rps.ms_rpt_gn_estimate values (?,?,?,?,?,?,?,?,?)

                                ]]></target>

                        </command>

                </try>
                <catch>
                </catch>
        </command>
</sqml>

