 
<!-- LOAD MAINFRAME KSRB235_APC_STAGE TABLE  -->

<sqml>
	<property name="TIMEOUT" value="0"/>
	<datasources resource="datasource.xml"/>
	<properties resource="datamart.properties"/>

		   
     <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        dmt_schema=script.getProperty("dmt_schema");
        pmt_schema=script.getProperty("pmt_schema");
	]]></command>
	

	<command type="try">
		<try>



<!--  12/12/2006 jjt get the set of period_ids being requested to generate sql literals for WHERE -->
<!--  09/25/2008 Payments job pass prcs_nb as parameter to improve job performance                -->

	    
			<!-- Copy from UDB to mainframe DB2. -->
			<command type="copy" batch="500">
				<source type="sql" datasource="datamart"><![CDATA[
 with gids ( PRCS_NB, period_id, gid) as ( 
  select R.PRCS_NB, R.RBAT_BILL_PRD_NM, R.CLM_GID 
   FROM ${pmt_schema}.KSRB230_RBLL_STAGE R  
  WHERE 
    R.TRAN_TYP_CD        in ('M ','E')                       AND
    R.PRCS_NB          = ${PRCS_NB}                          AND
    r.rbat_bill_prd_nm = '${QTR}'
  )
  SELECT    
                         C.PERIOD_ID 
						,C.RBATE_ID
						,C.RAC
						,C.LCM_CODE           
						,C.EXTNL_SRC_CODE     
						,C.EXTNL_LVL_ID1      
						,C.EXTNL_LVL_ID2      
						,C.EXTNL_LVL_ID3      
						,C.EXTNL_LVL_ID4      
						,C.EXTNL_LVL_ID5 
						,C.NDC
						,C.CYCLE_GID_QQYY
						,C.NEW_RFIL_CD        
						,C.RX_NB              
						,C.MAIL_ORDER_CODE    
						,C.DSPND_DATE         
						,C.UNIT_QTY           
						,C.DAYS_SPLY          
						,C.INGRD_CST          
						,C.MBR_RBTE_DISC_AMT  
						,C.PRIOR_ATHZN_FLAG 
						,C.FRMLY_ID       
						,C.COPAY_SRC_CODE     
						,C.INSRD_ID           
						,C.SFX_CODE           
						,C.NABP_CODE          
						,C.CHN_NBR            
						,C.PPO_NBR            
						,C.PICO_NO            
						,C.CNTRL_NO           
						,C.BSKT_NAME          
						,C.RBATE_ACCESS       
						,C.RBATE_MRKT_SHR     
						,C.RBATE_ADMIN_FEE    
						,C.AWP_UNIT_CST       
						,C.EXCPT_STAT         
						,C.EXCPT_CODE         
						,C.INV_GID            
						,C.CLM_USE_SRX_CD     
						,C.GNRC_IND             
						,C.USER_FIELD6_FLG      
						,C.CLAIM_TYPE         
						,C.CLAIM_LVL1           
						,C.CLAIM_LVL2           
						,C.CLAIM_LVL3
						,C.INV_MODEL            
						,C.POSR_IND  
						,C.POSR_RBAT_CLNT_SHR   
						,C.POSR_RBAT_MBR_SHR    
						,C.POSR_RBAT_TOT_SHR    
						,C.NHU_TYP_CD           
						,C.MEDD_PLAN_TYP_CD     
						,C.MEDD_CNTRC_ID        
						,C.MEDD_PRTC_CD         
						,C.MEDD_DRUG_CD         
						,C.FRMLY_DRUG_STAT_CD   
						,C.FRMLY_DRUG_TIER_VL   
						,C.PLAN_TIER_VL         
						,C.AMT_PAID             
						,C.CNTRC_FEE_PAID    
						,C.AMT_COPAY         
						,C.CLAIM_GID         
						,C.FRMLY_SRC_CD      
						,C.BNFT_LVL_CD       
						,C.POSR_CALC_MTHD_CD 
						,C.POSR_RATE_PCT     
						,C.POST_CLNT_SHR_PCNT
						,C.POSR_MODL_PCT     
						,C.STEP_THER_USE_CD  
						,C.PAYER_ID          
						,C.AMT_TAX           
						,C.INS_CD
                        ,G.PRCS_NB
                                                ,COALESCE(C.INV_FRMLY_STAT_CD,'') AS INV_FRMLY_STAT_CD
                                                ,COALESCE(C.CALC_BRND_XLAT_CD,'') AS CALC_BRND_XLAT_CD
                                                ,COALESCE(C.INCNTV_TYP_CD,0) AS INCNTV_TYP_CD
                                                ,COALESCE(C.RPT_ID,0) AS RPT_ID
                                                ,COALESCE(C.DLVRY_SYS_CD, 0) AS DLVRY_SYS_CD
           FROM ${dmt_schema}.tapc_detail_${QTR} C, gids G
           WHERE C.PERIOD_ID          = G.period_id  AND
                 C.CLAIM_GID          = G.gid     

				]]></source> 
			 <target type= "queue" threads="4" >  
				<target
					type             = "sql"
					datasource       = "db2p"
					transaction      = "true"
					batch            = "500"
					reportInterval   = "500"
					queryTimeout     = "${TIMEOUT}" 
				><![CDATA[
				    INSERT INTO ${pmt_schema}.ksrb235_apc_stage                             
					VALUES
        			( 
		                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,  
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,   
                                 ?, ?, ?, ?, ?, ?, ?, ?                         
	         		)
				]]></target>
			 </target>
			</command>
    
	        <!-- compare totals -->

			  
		</try>
		<catch>
			<!-- Send an email on error -->
		<command
				type="mail"
				mailTo="${mailto}"
				mailFrom="getAPC"
				subject="[ERROR] MF load KSRB235 "
				contentType="text/html"
				throwsException="false"
			><![CDATA[
				<html>
				<head>
				<title>[ERROR] MF LOAD KSRB235</title>
				</head>
				<body>
			
				<h3><u>[ERROR] MF LOAD KSRB235 </u></h3>
			
				<table cellpadding="2">
					<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
					<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
					<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
					#if (${system.getProperty('logfile')})
						<tr>
							<td><b>Log File:</b></td>
							<td>
								${system.getProperty('logfile')}
							<td>
						</tr>
					#end
				</table>

				<br>			
				<br>
				
				#if (${script.getLastStatement()})
					<h3><u>Last Statement</u></h3>
					<font style="color: blue; font-size: small">	
					${script.getLastStatement()}
					</font>
				
					<br>
					<br>
				#end
			
				<h3><u>Stack Trace</u></h3>		
				<pre style="color: red; font-size: small;">${stackTrace}</pre>
				</body>
				</html>
			]]></command>
		
		
		</catch>
	</command>
</sqml>
