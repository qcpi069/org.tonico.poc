  <sqml>
	<property name="TIMEOUT" value="0"/>
	<datasources resource="datasource.xml"/>
	<properties resource="datamart.properties"/>
        <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        dmt_schema=script.getProperty("dmt_schema");
	pmt_schema=script.getProperty("pmt_schema");
	cli_schema=script.getProperty("cli_schema");
	]]></command>


    <command type="try">
	<try>
        <!--  delete from UDB  --> 
	<command type="run" datasource="datamart">
	<![CDATA[ 
	
	DELETE FROM ${dmt_schema}.trebate_id_qtr 
				
	]]> 
	</command>


	<command type="copy" batch="1000">
				<source type="sql" datasource="datamart"><![CDATA[
Select rebid_period.RBATE_ID AS Rebate_Id,
rebid_period.PERIOD_ID Inv_Qtr, 
Client_Reg.MSTR_CLIENT_NAM, 
Client_Reg.Rebate_ID_Name, 
Client_Reg.MODEL_TYPE_DESC, 
Client_Reg.Company, 
Client_Reg.Vendor, 
Client_Reg.Pay_Timing, 
Client_Reg.Pay_Schedule, 
Client_Reg.PAY_METHOD_DESC, 
Client_Reg.SAP_PAY_TYPE_DESC, 
Client_Reg.Credit_Hold, 
Client_Reg.Model_Eff_Dt, 
Client_Reg.Model_Term_Dt, 
Client_Reg.Model_Eff_yyyymm, 
Client_Reg.Model_Term_yyyymm, 
Client_Reg.Model_Eff_Qtr, 
Client_Reg.Model_Term_Qtr,
Client_Reg.FAF_NBR, 
Client_Reg.QL_CLIENT_NBR, 
Client_Reg.PSI_Rebate_Id, 
Client_Reg.CLIENT_TYPE_DESC, 
Client_Reg.PROCESSOR_DESC, 
Client_Reg.PROCESSOR_SORT, 
Client_Reg.CLIENT_TYPE_SORT, 
Client_Reg.SAP_PAY_TYPE_SORT, 
Client_Reg.PAY_METHOD_SORT, 
Client_Reg.MODEL_TYPE_SORT, 
Client_Reg.PSI_Master_Id, 
Client_Reg.REBATE_INV_EFF_DT, 
Client_Reg.REBATE_INV_TERM_DT 
From 
(select distinct rbat_id AS RBATE_ID, rbat_bill_yr_dt || rbat_bill_qtr_dt as PERIOD_ID
   from ${pmt_schema}.ksrb112_rbp)   rebid_period
left join
(SELECT 
RBATE_REG.CLIENT.CLIENT_NBR,
RPS.L_QTRS.Inv_Qtr,
RBATE_REG.MASTER_CLIENT.MSTR_CLIENT_NAM, 
RBATE_REG.CLIENT.CLIENT_NAME AS Rebate_ID_Name, 
RPS.L_MODEL_TYPE.MODEL_TYPE_DESC, 
RBATE_REG.CLIENT.AP_COMPNY_CD AS Company, 
RBATE_REG.CLIENT.AP_NBR AS Vendor, 
RBATE_REG.CLIENT.PAYMENT_TIMING AS Pay_Timing, 
(CASE 
 WHEN PAYMENT_SCHEDULE ='Q' THEN 'Quarterly' 
 WHEN PAYMENT_SCHEDULE ='M' THEN 'Monthly' 
 ELSE PAYMENT_SCHEDULE END) AS Pay_Schedule, 
RPS.L_PAY_METHOD.PAY_METHOD_DESC, 
RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_DESC, 
RBATE_REG.CLIENT.CREDIT_HOLD_CD AS Credit_Hold, 
RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT AS Model_Eff_Dt, 
RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT AS Model_Term_Dt, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),1,4) || SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),6,2)  AS Model_Eff_yyyymm, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),1,4)|| SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),6,2) AS Model_Term_yyyymm, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),1,4) || 'Q' || CHAR(QUARTER(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT)) AS Model_Eff_Qtr, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),1,4)|| 'Q' || CHAR(QUARTER(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT))AS Model_Term_Qtr,
RBATE_REG.CLIENT.FAF_NBR, 
RBATE_REG.CLIENT.QL_CLIENT_NBR, 
RBATE_REG.CLIENT.PCS_SYSTEM_ID AS PSI_Rebate_Id, 
RPS.L_CLIENT_TYPE.CLIENT_TYPE_DESC, 
RPS.L_PROCESSOR_TYPE.PROCESSOR_DESC, 
RPS.L_PROCESSOR_TYPE.PROCESSOR_SORT, 
RPS.L_CLIENT_TYPE.CLIENT_TYPE_SORT, 
RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_SORT, 
RPS.L_PAY_METHOD.PAY_METHOD_SORT, 
RPS.L_MODEL_TYPE.MODEL_TYPE_SORT, 
RBATE_REG.MASTER_CLIENT.PCS_SYSTEM_ID AS PSI_Master_Id, 
RBATE_REG.REBATE_INVOICE.REBATE_INV_EFF_DT, 
RBATE_REG.REBATE_INVOICE.REBATE_INV_TERM_DT 
FROM (select distinct rbat_id AS RBATE_ID, rbat_bill_yr_dt || rbat_bill_qtr_dt as PERIOD_ID
        from ${pmt_schema}.ksrb112_rbp)   rebid_period2,
RPS.L_QTRS,
RBATE_REG.CLIENT  INNER JOIN RBATE_REG.CLIENT_MASTER_ASSOC 
 ON (RBATE_REG.CLIENT.PCS_SYSTEM_ID= RBATE_REG.CLIENT_MASTER_ASSOC.CLT_PCS_SYSTEM_ID   )
INNER JOIN     RBATE_REG.MASTER_CLIENT
        ON (RBATE_REG.CLIENT_MASTER_ASSOC.MSTR_PCS_SYSTEM_ID = RBATE_REG.MASTER_CLIENT.PCS_SYSTEM_ID)   
INNER JOIN RBATE_REG.REBATE_INVOICE 
    ON (RBATE_REG.REBATE_INVOICE.PCS_SYSTEM_ID = RBATE_REG.CLIENT.PCS_SYSTEM_ID ) 
LEFT JOIN RBATE_REG.CLIENT_MODEL_ASSOC 
    ON (RBATE_REG.CLIENT.PCS_SYSTEM_ID = RBATE_REG.CLIENT_MODEL_ASSOC.PCS_SYSTEM_ID) 
LEFT JOIN RPS.L_SAP_PAY_METHOD 
    ON (RBATE_REG.CLIENT.SAP_PAYMENT_TYPE = RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_CD) 
LEFT JOIN RPS.L_PAY_METHOD 
    ON (RBATE_REG.CLIENT.PAYMENT_TYPE = RPS.L_PAY_METHOD.PAY_METHOD_CD) 
LEFT JOIN RPS.L_CLIENT_TYPE 
    ON (RBATE_REG.CLIENT.CLIENT_TYPE = RPS.L_CLIENT_TYPE.CLIENT_TYPE_CD) 
LEFT JOIN RPS.L_PROCESSOR_TYPE 
    ON (RBATE_REG.CLIENT.PROCESSOR_CD = RPS.L_PROCESSOR_TYPE.PROCESSOR_CD) 
LEFT JOIN RPS.L_MODEL_TYPE 
    ON (RBATE_REG.CLIENT_MODEL_ASSOC.MODEL_TYPE_CODE = RPS.L_MODEL_TYPE.MODEL_TYPE_CD)
WHERE  RBATE_REG.CLIENT_MASTER_ASSOC.EFF_DT <=  RPS.L_QTRS.QTR_END_DT 
 AND  ((RBATE_REG.CLIENT_MASTER_ASSOC.TERM_DT is null) 
      or (RBATE_REG.CLIENT_MASTER_ASSOC.TERM_DT >=  RPS.L_QTRS.QTR_BEGIN_DT)) 
  AND  RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT <=  RPS.L_QTRS.QTR_END_DT 
  AND  ((RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT is null)  or (RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT >=  RPS.L_QTRS.QTR_BEGIN_DT)) 
and RBATE_REG.CLIENT.CLIENT_NBR = REBID_PERIOD2.RBATE_ID and RPS.L_QTRS.Inv_Qtr = REBID_PERIOD2.PERIOD_ID) as Client_Reg
on REBID_PERIOD.RBATE_ID =  Client_Reg.CLIENT_NBR
    and  REBID_PERIOD.PERIOD_ID = Client_Reg.Inv_Qtr

				]]></source>
				   <target
					type             = "sql"
					datasource       = "datamart"
					transaction      = "true"
					batch            = "1000"
					reportInterval   = "1000"
					queryTimeout     = "${TIMEOUT}"
				><![CDATA[
Insert into ${dmt_schema}.TREBATE_ID_QTR
         (CLIENT_NB,
	 PERIOD_ID,
	 MSTR_CLIENT_NM,
	 CLIENT_NM,
	 MODEL_TYPE_DESC_TXT,
	 AP_COMPNY_CD,
	 AP_NB,
	 PMT_FREQ_CD,
	 PMT_SCHD_TXT,
	 PMT_MTHD_DESC_TXT,
	 SAP_PMT_TYPE_DESC_TXT,
	 CREDIT_HOLD_CD,
	 MODEL_EFF_DT,
	 MODEL_TERM_DT,
	 MODEL_EFF_YR_MO_DT,
	 MODEL_TERM_YR_MO_DT,
	 MODEL_EFF_QTR_TXT,
	 MODEL_TERM_QTR_TXT,
	 FAF_NB,
	 QL_CLIENT_NB,
	 PSI_REBATE_ID,
	 CLIENT_TYPE_DESC_TXT,
	 PRCSR_DESC_TXT,
	 PRCSR_SEQ_NB,
	 CLIENT_TYPE_SEQ_NB,
	 SAP_PMT_TYPE_SEQ_NB,
	 PMT_MTHD_SEQ_NB,
	 MODEL_TYPE_SEQ_NB,
	 PSI_MSTR_ID,
	 REBATE_INV_EFF_DT,
	 REBATE_INV_TERM_DT)
     Values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

				]]></target>
		
	</command>
	
	<command type="copy" batch="1000">
				<source type="sql" datasource="datamart"><![CDATA[
SELECT RBATE_REG.CLIENT.CLIENT_NBR AS Rebate_Id,
RPS.L_QTRS.Inv_Qtr, 
RBATE_REG.MASTER_CLIENT.MSTR_CLIENT_NAM, 
RBATE_REG.CLIENT.CLIENT_NAME AS Rebate_ID_Name, 
RPS.L_MODEL_TYPE.MODEL_TYPE_DESC, 
RBATE_REG.CLIENT.AP_COMPNY_CD AS Company, 
RBATE_REG.CLIENT.AP_NBR AS Vendor, 
RBATE_REG.CLIENT.PAYMENT_TIMING AS Pay_Timing, 
(CASE 
 WHEN PAYMENT_SCHEDULE ='Q' THEN 'Quarterly' 
 WHEN PAYMENT_SCHEDULE ='M' THEN 'Monthly' 
 ELSE PAYMENT_SCHEDULE END) AS Pay_Schedule, 
RPS.L_PAY_METHOD.PAY_METHOD_DESC, 
RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_DESC, 
RBATE_REG.CLIENT.CREDIT_HOLD_CD AS Credit_Hold, 
RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT AS Model_Eff_Dt, 
RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT AS Model_Term_Dt, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),1,4) || SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),6,2) AS Model_Eff_yyyymm, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),1,4) || SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),6,2) AS Model_Term_yyyymm, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT),1,4) || 'Q' || CHAR(QUARTER(RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT)) AS Model_Eff_Qtr, 
SUBSTR(CHAR(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT),1,4) || 'Q' || CHAR(QUARTER(RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT)) AS Model_Term_Qtr, RBATE_REG.CLIENT.FAF_NBR, RBATE_REG.CLIENT.QL_CLIENT_NBR, 
RBATE_REG.CLIENT.PCS_SYSTEM_ID AS PSI_Rebate_Id,
RPS.L_CLIENT_TYPE.CLIENT_TYPE_DESC, 
RPS.L_PROCESSOR_TYPE.PROCESSOR_DESC, 
RPS.L_PROCESSOR_TYPE.PROCESSOR_SORT, 
RPS.L_CLIENT_TYPE.CLIENT_TYPE_SORT, 
RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_SORT, 
RPS.L_PAY_METHOD.PAY_METHOD_SORT, 
RPS.L_MODEL_TYPE.MODEL_TYPE_SORT, 
RBATE_REG.MASTER_CLIENT.PCS_SYSTEM_ID AS PSI_Master_Id, 
RBATE_REG.REBATE_INVOICE.REBATE_INV_EFF_DT, 
RBATE_REG.REBATE_INVOICE.REBATE_INV_TERM_DT 
FROM RPS.L_QTRS, 
RBATE_REG.MASTER_CLIENT INNER JOIN RBATE_REG.CLIENT_MASTER_ASSOC 
 ON (RBATE_REG.CLIENT_MASTER_ASSOC.MSTR_PCS_SYSTEM_ID = RBATE_REG.MASTER_CLIENT.PCS_SYSTEM_ID) 
INNER JOIN RBATE_REG.CLIENT 
 ON (RBATE_REG.CLIENT.PCS_SYSTEM_ID = RBATE_REG.CLIENT_MASTER_ASSOC.CLT_PCS_SYSTEM_ID ) 
 INNER JOIN RBATE_REG.REBATE_INVOICE 
 ON (RBATE_REG.REBATE_INVOICE.PCS_SYSTEM_ID = RBATE_REG.CLIENT.PCS_SYSTEM_ID ) 
LEFT JOIN RBATE_REG.CLIENT_MODEL_ASSOC 
 ON (RBATE_REG.CLIENT.PCS_SYSTEM_ID = RBATE_REG.CLIENT_MODEL_ASSOC.PCS_SYSTEM_ID) 
LEFT JOIN RPS.L_SAP_PAY_METHOD 
 ON (RBATE_REG.CLIENT.SAP_PAYMENT_TYPE = RPS.L_SAP_PAY_METHOD.SAP_PAY_TYPE_CD) 
LEFT JOIN RPS.L_PAY_METHOD 
 ON (RBATE_REG.CLIENT.PAYMENT_TYPE = RPS.L_PAY_METHOD.PAY_METHOD_CD) 
LEFT JOIN RPS.L_CLIENT_TYPE 
 ON (RBATE_REG.CLIENT.CLIENT_TYPE = RPS.L_CLIENT_TYPE.CLIENT_TYPE_CD) 
LEFT JOIN RPS.L_PROCESSOR_TYPE 
 ON (RBATE_REG.CLIENT.PROCESSOR_CD = RPS.L_PROCESSOR_TYPE.PROCESSOR_CD) 
LEFT JOIN RPS.L_MODEL_TYPE 
 ON (RBATE_REG.CLIENT_MODEL_ASSOC.MODEL_TYPE_CODE = RPS.L_MODEL_TYPE.MODEL_TYPE_CD) 
WHERE  RBATE_REG.CLIENT_MASTER_ASSOC.EFF_DT <=  RPS.L_QTRS.QTR_END_DT 
  AND  ((RBATE_REG.CLIENT_MASTER_ASSOC.TERM_DT is null) or (RBATE_REG.CLIENT_MASTER_ASSOC.TERM_DT >=  RPS.L_QTRS.QTR_BEGIN_DT)) 
  AND  RBATE_REG.CLIENT_MODEL_ASSOC.EFF_DT <=  RPS.L_QTRS.QTR_END_DT 
  AND  ((RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT is null) or (RBATE_REG.CLIENT_MODEL_ASSOC.TERM_DT >=  RPS.L_QTRS.QTR_BEGIN_DT)) 
  AND  (RBATE_REG.REBATE_INVOICE.REBATE_INV_EFF_DT <=  RPS.L_QTRS.QTR_END_DT) 
  AND  ((RBATE_REG.REBATE_INVOICE.REBATE_INV_TERM_DT is null) 
   or (RBATE_REG.REBATE_INVOICE.REBATE_INV_TERM_DT >=  RPS.L_QTRS.QTR_BEGIN_DT))
  AND (RBATE_REG.CLIENT.CLIENT_NBR,  RPS.L_QTRS.Inv_Qtr) not in ( SELECT CLIENT_NB, PERIOD_ID
                                                                      FROM ${dmt_schema}.TREBATE_ID_QTR)

				]]></source>
				   <target
					type             = "sql"
					datasource       = "datamart"
					transaction      = "true"
					batch            = "1000"
					reportInterval   = "1000"
					queryTimeout     = "${TIMEOUT}"
				><![CDATA[
Insert into ${dmt_schema}.TREBATE_ID_QTR
         (CLIENT_NB,
	 PERIOD_ID,
	 MSTR_CLIENT_NM,
	 CLIENT_NM,
	 MODEL_TYPE_DESC_TXT,
	 AP_COMPNY_CD,
	 AP_NB,
	 PMT_FREQ_CD,
	 PMT_SCHD_TXT,
	 PMT_MTHD_DESC_TXT,
	 SAP_PMT_TYPE_DESC_TXT,
	 CREDIT_HOLD_CD,
	 MODEL_EFF_DT,
	 MODEL_TERM_DT,
	 MODEL_EFF_YR_MO_DT,
	 MODEL_TERM_YR_MO_DT,
	 MODEL_EFF_QTR_TXT,
	 MODEL_TERM_QTR_TXT,
	 FAF_NB,
	 QL_CLIENT_NB,
	 PSI_REBATE_ID,
	 CLIENT_TYPE_DESC_TXT,
	 PRCSR_DESC_TXT,
	 PRCSR_SEQ_NB,
	 CLIENT_TYPE_SEQ_NB,
	 SAP_PMT_TYPE_SEQ_NB,
	 PMT_MTHD_SEQ_NB,
	 MODEL_TYPE_SEQ_NB,
	 PSI_MSTR_ID,
	 REBATE_INV_EFF_DT,
	 REBATE_INV_TERM_DT)
     Values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
				]]></target>
		
	</command>

	<!--  Update Rows with Client specific data  --> 
	<command type="run" datasource="datamart">
	<![CDATA[ 
	
	UPDATE ${dmt_schema}.TREBATE_ID_QTR  
		SET     (CLIENT_NM,
			AP_COMPNY_CD, 
			AP_NB,
			PMT_FREQ_CD, 
			CREDIT_HOLD_CD, 
			FAF_NB, 
			QL_CLIENT_NB, 
			PSI_REBATE_ID) =
		(SELECT C.CLIENT_NAME,
			C.AP_COMPNY_CD,
			C.AP_NBR,
			C.PAYMENT_TIMING,
			C.CREDIT_HOLD_CD,
			C.FAF_NBR,
			C.QL_CLIENT_NBR,
			C.PCS_SYSTEM_ID
           FROM rbate_reg.client C
	   WHERE ${dmt_schema}.TREBATE_ID_QTR.CLIENT_NB = C.CLIENT_NBR)
	WHERE CLIENT_NM is null
				
	]]> 
	</command>
		
			
	<!--  Update Rows with null model_type_desc  --> 
		
        <command type="run" datasource="datamart">
        <![CDATA[

       UPDATE ${dmt_schema}.TREBATE_ID_QTR
                SET     (model_type_desc_txt) =
        ( select RPS.L_MODEL_TYPE.model_type_desc
                from
        rbate_reg.client , RBATE_REG.CLIENT_MODEL_ASSOC , RPS.L_MODEL_TYPE
        where rbate_reg.client.client_nbr = rps.trebate_id_qtr.client_nb
                and rbate_reg.client.PCS_SYSTEM_ID = RBATE_REG.CLIENT_MODEL_ASSOC.PCS_SYSTEM_ID
                and RBATE_REG.CLIENT_MODEL_ASSOC.MODEL_TYPE_CODE = RPS.L_MODEL_TYPE.MODEL_TYPE_CD)
        WHERE model_type_desc_txt is null


        ]]>
        </command>

		     </try>
	<catch>
	<!-- Send an email on error -->
			<command
				type="mail"
				mailTo="${mailto}"
				mailFrom="TREBATE_ID_QTR load"
				subject="[ERROR] REFESH - TREBATE_ID_QTR "
				contentType="text/html"
				throwsException="false"
			><![CDATA[
				<html>
				<head>
				<title>[ERROR] TREBATE_ID_QTR load </title>
				</head>
				<body>
			
				<h3><u>[ERROR] TREBATE_ID_QTR load </u></h3>
			
				<table cellpadding="2">
					<tr><td><b>Host:</b></td><td>${localhost}<td></tr>
					<tr><td><b>Started:</b></td><td>${startTime}<td></tr>
					<tr><td><b>Script:</b></td><td>${scriptName}<td></tr>
					#if (${system.getProperty('logfile')})
						<tr>
							<td><b>Log File:</b></td>
							<td>
								${system.getProperty('logfile')}
							<td>
						</tr>
					#end
				</table>

				<br>			
				<br>
				
				#if (${script.getLastStatement()})
					<h3><u>Last Statement</u></h3>
					<font style="color: blue; font-size: small">	
					${script.getLastStatement()}
					</font>
				
					<br>
					<br>
				#end
			
				<h3><u>Stack Trace</u></h3>		
				<pre style="color: red; font-size: small;">${stackTrace}</pre>
				</body>
				</html>
			]]>
		     </command>
		</catch>
	</command>
  </sqml>

