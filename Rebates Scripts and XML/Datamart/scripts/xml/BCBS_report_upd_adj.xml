<?xml version="1.0" encoding="utf-8"?>
<sqml>
  <property name="TIMEOUT" value="0" />
  <datasources resource="datasource.xml" />
  <properties resource="datamart.properties" />
  <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        cli_schema=script.getProperty("cli_schema");        
	]]></command>
  <command type="try">
    <try>
      <!-- delete from BCBS_adjust_pct -->
      <command type="run" datasource="datamart"><![CDATA[
                                        DELETE FROM rps.BCBS_adjust_pct
                                ]]></command>
      <!--  derive invoice/adjustment/collection from F_sl_client_sum per Inv_qtr/rebateID  -->
      <command type="copy">
        <source type="sql" datasource="datamart"><![CDATA[
select coalesce(sum(case when TRAN_TYPE_CD='I1' then AMOUNT else 0 end),0) as invoice,
coalesce(sum(case when TRAN_TYPE_CD in ('Q1','Q2','M1','M2','W1','W2','U1','U2')  then AMOUNT else 0 end),0) as adjustment,
coalesce(sum(case when TRAN_TYPE_CD='P1' then AMOUNT else 0 end),0) as collection
from rps.f_sl_client_sum
where inv_qtr = '${QPARM}' and REBATE_ID='${RBATE}'

                                ]]></source>
        <target type="sql" datasource="datamart" transaction="true" queryTimeout="${TIMEOUT}"><![CDATA[
                                        insert into rps.BCBS_adjust_pct values
                                                (?,?,?)

                                ]]></target>
      </command>
      <!--  update BCBS_adjust_pct.invoice_lkp  -->
      <command type="run" datasource="datamart" batch="1000"><![CDATA[

        UPDATE rps.BCBS_adjust_pct
                SET
                        INVOICE_LKP =
                (SELECT sum(INVOICE_AMT)*-1 from rps.bcbs_report
                        WHERE inv_qtr = '${QPARM}' and REBATE_ID='${RBATE}'
                 )
	where INVOICE_LKP=0

        ]]></command>
      <!--  Update APC raw data, set Adjust_AMT  -->
      <command type="run" datasource="datamart" batch="1000"><![CDATA[

        UPDATE rps.BCBS_report r
            SET ADJ_AMT =
                (SELECT case a.invoice_lkp
			  when 0 then 0
			  else r.INVOICE_AMT* (a.adjust_lkp/a.invoice_lkp)
			end
	          FROM  rps.BCBS_adjust_pct a
                 )
        WHERE inv_qtr = '${QPARM}' and REBATE_ID='${RBATE}'

        ]]></command>
    </try>
    <catch></catch>
  </command>
</sqml>