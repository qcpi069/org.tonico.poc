<sqml>
        <property name="TIMEOUT" value="0"/>
        <datasources resource="datasource.xml"/>
        <properties resource="datamart.properties"/>

    <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        dmt_schema=script.getProperty("dmt_schema");
        ]]></command>

        <command type="try">
                <try>
                        <command type="copy" batch="1000">
                                <source type="sql" datasource="datamart"
                                        ><![CDATA[

with

 chkln (rbid, rac_id, inv_qtr,  pmt_amt,  pmt_rls_dt, prcs_nb, inv_qtr_dt,stmt_id ) as
   ( select RBID,RAC,INV_QTR,PMT_AMT,PMT_RLS_DT,PRCS_NB,INV_QTR_DT,STMD_ID
	from rps.ms_chkln
    ),

 adv_qtr (rac_id, inv_qtr, formula, share) as
   (select r.rac_id,  r.inv_qtr, s.formula, max(case when formula in ('A','P') then CLNT_SPLT_PCT else 0 end) as client_share
    from rps.t_splits_pricing_base s inner join chkln r
                on r.rac_id = s.rac_id and (r.inv_qtr_dt between s.EFF_DT and s.TERM_DT)
		inner join client_reg.crt_clnt c 
		on r.rbid = substr(digits(c.rbat_id),3,8)
    where s.formula in ('A','P')
    and s.PRC_TERM_TYP_CD='1'
    and (s.alt_coal_rpt_in = 0 or c.ap_co_cd in (select ap_co_cd from rps.tcorp_ap_co_cd where corp_cd=2))
    group by r.rac_id, r.inv_qtr, s.formula

    union all
   
    select r.rac_id,  r.inv_qtr, s.formula, s.tier_splt_clnt_pct as client_share
		from rps.t_splits_pricing_base s inner join chkln r
                on r.rac_id = s.rac_id and (r.inv_qtr_dt between s.EFF_DT and s.TERM_DT)
		inner join client_reg.crt_clnt c 
		on r.rbid = substr(digits(c.rbat_id),3,8)
    where s.formula in ('R')
    and s.PRC_TERM_TYP_CD='1'
		and s.SPLIT_LEVEL ='99'
    and (s.alt_coal_rpt_in = 0 or c.ap_co_cd in (select ap_co_cd from rps.tcorp_ap_co_cd where corp_cd=2))

),

 r_adm_rule (rac_id, eff_dt, term_dt, maf_in ) as
   (select  distinct rac.rac_id, c.eff_dt, c.term_dt, ts.maf_in
	from client_reg.crt_clnt_rule_assc c
      		join client_reg.crt_clnt_prc_pool_assc rac
               		on c.rbat_id=rac.rbat_id
      		join client_reg.crt_prc_pool p
                	on p.prc_rule_id = c.prc_rule_id and p.pool_typ_cd = rac.pool_typ_cd
      		join client_reg.crt_prc_term_shr ts
                	on ts.prc_pool_id = p.prc_pool_id
      		join client_reg.crt_prc_tier tier
                	on ts.prc_term_shr_id=tier.prc_term_id
                        	and ts.PRC_TYP_CD=tier.PRC_TYP_CD
	where tier.prc_term_typ_cd = '1'
		and c.eff_dt<c.term_dt
		and FRMA_TYP_CD ='R'
),  

 adm_fee (rac_id, inv_qtr) as
   (select distinct r.rac_id,  r.inv_qtr
    from rps.t_splits_pricing_base s inner join chkln r
                on r.rac_id = s.rac_id and (r.inv_qtr_dt between s.EFF_DT and s.TERM_DT)
    where s.PRC_TYP_CD='A'

	union all

    select distinct r.rac_id,  r.inv_qtr
    from r_adm_rule s inner join chkln r
                on r.rac_id = s.rac_id and (r.inv_qtr_dt between s.EFF_DT and s.TERM_DT)
    where s.maf_in='1'

),

 tots (PRCS_NB,rbid,rac_id, inv_qtr, inv_orig, bami, inv_net, inv_net_cs, CAPs, CAPs_cs ) as
   (select PRCS_NB,rbid,chkln.rac_id,  chkln.inv_qtr,
    sum(case when f.tran_type_cd in ('I1','I2','I3') then f.amount * -1 else 0 end) as inv_orig,
    sum(case when f.tran_type_cd in ('Q1','Q2','M1','M2','W1','W2','U1','U2','E1','E2') then f.amount * -1 else 0 end) as bami,
    sum(case when f.tran_type_cd in ('I1','I2','I3','Q1','Q2','M1','M2','W1','W2','U1','U2','E1','E2') then f.amount * -1 else 0 end) as inv_net,
    sum(case when f.tran_type_cd in ('I1', 'M1', 'Q1', 'W1', 'C1','E1','U1','10') then f.amount * -1 else 0 end) as net_inv_cs,
    sum(case when f.tran_type_cd in ('P1','P2','P3') then f.amount else 0 end) as CAPs,
    sum(case when f.tran_type_cd in ('P1','P5','20')  then f.amount else 0 end) as CAPs_cs
   from rps.f_sl_client_sum f
   right outer join chkln on (chkln.rac_id = f.rac_id and chkln.inv_qtr = f.inv_qtr )
   where  (f.stmt_id <= chkln.stmt_id )
             and (chkln.rac_id,chkln.inv_qtr) not in (select * from adm_fee)
   group by PRCS_NB,rbid,chkln.rac_id, chkln.inv_qtr
 ),

 tots_adm (PRCS_NB,rbid,rac_id, inv_qtr, inv_orig, bami, inv_net, inv_net_cs, CAPs, CAPs_cs ) as
   (select PRCS_NB,rbid,chkln.rac_id,  chkln.inv_qtr,
    sum(case when f.tran_type_cd in ('I1','I2','I3','FA','FC') then f.amount * -1 else 0 end) as inv_orig,
    sum(case when f.tran_type_cd in ('Q1','Q2','M1','M2','W1','W2','F3','F4','F6','FQ','FM','FU','U1','U2','FW','E1','E2') then f.amount * -1 else 0 end) as bami,
    sum(case when f.tran_type_cd in ('I1','I2','I3','Q1','Q2','M1','M2','W1','W2','F3','F4','F6','FQ','FM','FU','U1','U2','FW','E1','E2','FA','FC') then f.amount * -1 else 0 end) as inv_net,
    sum(case when f.tran_type_cd in ('I1', 'M1', 'Q1', 'W1', 'C1','FC','F3','F4','F6','E1','C4','U1','10','12') then f.amount * -1 else 0 end) as net_inv_cs,
    sum(case when f.tran_type_cd in ('P1','P2','P3','F1','F2') then f.amount else 0 end) as CAPs,
    sum(case when f.tran_type_cd in ('P1','P5','F1','F7','20','22')  then f.amount else 0 end) as CAPs_cs
   from rps.f_sl_client_sum f
   right outer join chkln on (chkln.rac_id = f.rac_id and chkln.inv_qtr = f.inv_qtr )
   where  (f.stmt_id <= chkln.stmt_id )
             and (chkln.rac_id,chkln.inv_qtr) in (select * from adm_fee)
   group by PRCS_NB,rbid,chkln.rac_id, chkln.inv_qtr
 )

select t.* ,  a.share
from tots t inner join adv_qtr a
        on t.rac_id=a.rac_id and t.inv_qtr=a.inv_qtr
where a.share>0
union all 
select t.* ,  a.share
from tots_adm t inner join adv_qtr a
        on t.rac_id=a.rac_id and t.inv_qtr=a.inv_qtr
where a.share>0

                                ]]></source>

                                <target
                                        type             = "sql"
                                        datasource       = "datamart"
                                        transaction      = "true"
                                        batch            = "1000"
                                        reportInterval   = "1000"
                                        queryTimeout     = "${TIMEOUT}"
                                ><![CDATA[
                                              insert into rps.ms_rpt_section1 values (?,?,?,?,?,?,?,?,?,?,?)

                                ]]></target>

                        </command>

                </try>
                <catch>
                </catch>
        </command>
</sqml>

