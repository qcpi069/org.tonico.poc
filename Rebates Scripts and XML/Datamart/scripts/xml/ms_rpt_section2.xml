<sqml>
        <property name="TIMEOUT" value="0"/>
        <datasources resource="datasource.xml"/>
        <properties resource="datamart.properties"/>

    <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        dmt_schema=script.getProperty("dmt_schema");
        ]]></command>

        <command type="try">
                <try>
                        <command type="copy" batch="1000">
                                <source type="sql" datasource="datamart"
                                        ><![CDATA[
with
chks (be_id, rac_id, inv_qtr,inv_qtr_dt,PRCS_NB, AP_COMPNY_CD) as
( select distinct RBID,RAC,m.INV_QTR,INV_QTR_DT,PRCS_NB, TRIM(AP_CO_CD)
    from rps.ms_chkln m, (select RBAT_ID, AP_CO_CD from client_reg.crt_clnt ) c
   where integer(m.rbid)=c.RBAT_ID
),

--calculate GN at cg/lcm level

pricing_raw (rac,inv_qr, formula,basis, basis_qual,lcm, rate) as
(select f.RAC, cc.inv_qtr, formula, basis, basis_qual,lcm,rate
 from rps.ms_gn_pricing_all f inner join chks cc
        on cc.rac_id=f.RAC and cc.inv_qtr_dt between SPLIT_EFF_DT and SPLIT_TERM_DT
where rate>0
),

pricing (rac,inv_qr, formula,basis, basis_qual,lcm, rate) as
( select distinct rac,inv_qr, formula,basis, basis_qual,lcm, rate
        from pricing_raw
),

cnt(rac,rebate_id,inv_qtr,lcm,rbatRx,subRx,rbatBrand,subBrand,rbatFrmBrd,subFrmBrd ) as
(select RAC_NB, RBAT_ID, INV_CCYY||INV_QTR, SUM_LCM_CD,
   sum(CASE WHEN CLM_CNT_TYP_CD='01' THEN RBAT_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='01' THEN SUBM_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='03' THEN RBAT_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='03' THEN SUBM_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='07' THEN RBAT_CLM_CNT
            ELSE 0 END),
   sum(CASE WHEN CLM_CNT_TYP_CD='07' THEN SUBM_CLM_CNT
            ELSE 0 END)
from rps.tapc_lcm_summary c inner join (select distinct rac_id, AP_COMPNY_CD from chks) a
        on c.RAC_NB=a.rac_id
where (
          ( a.AP_COMPNY_CD <> '170' AND RTRIM(SUM_LCM_CD) IN ('2','3','4','4E','5') )
       OR ( a.AP_COMPNY_CD = '170' AND RTRIM(SUM_LCM_CD) IN ('2T', '3T') )
      )
group by RAC_NB, RBAT_ID, INV_CCYY||INV_QTR, SUM_LCM_CD
),

cal (rac, inv_qtr,basis, lcm, rate, count ) as
(select cnt.rac, inv_qtr,basis,cnt.lcm, pricing.rate,
        (CASE WHEN pricing.basis='SUBMITTED' THEN
                        (CASE WHEN pricing.basis_qual='BRAND' THEN subBrand
                              WHEN pricing.basis_qual='Formulary Brand' THEN subFrmBrd
                                ELSE subRx END)
                WHEN pricing.basis='REBATED' THEN
                        (CASE WHEN pricing.basis_qual='BRAND' THEN rbatBrand
                              WHEN pricing.basis_qual='Formulary Brand' THEN rbatFrmBrd
                                ELSE rbatRx END)
                WHEN pricing.basis='BRAND' THEN subBrand
                WHEN pricing.basis is null THEN -99999
                ELSE -88888 END)
from cnt inner join pricing on (cnt.rac=pricing.rac and cnt.inv_qtr=pricing.inv_qr and cnt.lcm=pricing.lcm)
where basis_qual<>'NONE'
--all tiers count
union all
(select cnt.rac, inv_qtr,basis,'0', pricing.rate,
        sum(CASE WHEN pricing.basis='SUBMITTED' THEN subRx
                WHEN pricing.basis='REBATED' THEN rbatRx
                WHEN pricing.basis='BRAND' THEN subBrand
                WHEN pricing.basis is null THEN -99999
                ELSE -88888 END)
from cnt inner join pricing on cnt.rac=pricing.rac and cnt.inv_qtr=pricing.inv_qr
where basis_qual='NONE' and basis<>'ENROLLMENT'
group by cnt.rac,inv_qtr,basis,'0',pricing.rate)
--
)

select PRCS_NB,be_id,cal.rac,cal.inv_qtr,cal.basis,cal.rate,cal.lcm,substr(sc.CDSET_VL_DESC_TXT,1,10),cal.count,count*rate
from cal
                       inner join chks on cal.rac=chks.rac_id and cal.inv_qtr=chks.inv_qtr
join (select CDSET_VL, CDSET_VL_DESC_TXT
                from client_reg.crt_cdset cd join client_reg.crt_cdset_vl cv
                        on cd.CDSET_ID=cv.CDSET_ID where CDSET_DESC_TXT='CLM_TYP_QLFR_VL' ) sc
        on cal.lcm=sc.CDSET_VL

where cal.count<>0


                                ]]></source>

                                <target
                                        type             = "sql"
                                        datasource       = "datamart"
                                        transaction      = "true"
                                        batch            = "1000"
                                        reportInterval   = "1000"
                                        queryTimeout     = "${TIMEOUT}"
                                ><![CDATA[
                                              insert into rps.ms_rpt_section2 values (?,?,?,?,?,?,?,?,?,?)

                                ]]></target>

                        </command>

                </try>
                <catch>
                </catch>
        </command>
</sqml>


