
<!-- REFRESH rps.t_splits_base  -->

<sqml>
	<property name="TIMEOUT" value="0"/>
	<datasources resource="datasource.xml"/>
	<properties resource="datamart.properties"/>

    <command type="java"><![CDATA[
        mailto=script.getProperty("mailto");
        cli_schema=script.getProperty("cli_schema");        
	]]></command>
		       
	<command type="try">
		<try>

                      <!-- truncate table rps.t_splits_base -->
                        <command type="run" datasource="datamart">
                                <![CDATA[
                                        DELETE FROM rps.t_splits_base
                                ]]>
                        </command>

            <!-- *************** refresh table rps.t_splits_base ********************* -->
			<command type="copy" batch="1000">
				<source type="sql" datasource="datamart"><![CDATA[
select
(case when c.rbat_id>9999999 then trim(char(c.rbat_id)) 
when c.rbat_id>999999 then '0'||trim(char(c.rbat_id)) 
when c.rbat_id>99999 then '00'||trim(char(c.rbat_id)) 
else  '000'||trim(char(c.rbat_id)) end),
        pa.rac_id,
qtr.PERIOD_ID,
        ti.prc_term_typ_cd,
        pp.pool_typ_cd,
        ts.frma_typ_cd,
        base.CDSET_VL_DESC_TXT as clm_typ_cd,
        qbase.CDSET_VL_DESC_TXT as clm_typ_qlfr_cd,
        ti.clm_typ_qlfr_vl,
        ts.clnt_min_amt,
        ts.clnt_max_amt,
        ts.clnt_min_typ_cd,
        ts.clnt_max_typ_cd,
        ts.clnt_splt_pct,
        ts.co_splt_pct,
        ts.othr_splt_pct,
        ti.tier_up_lvl_amt,
        ti.tier_up_lvl_qty,
        ti.tier_splt_clnt_pct,
        ti.tier_splt_co_pct,
        ti.tier_splt_othr_pct,
        ts.pmpm_cd,
        ts.co_1_amt,
        ra.eff_dt, ra.term_dt,
        pm.prc_mstr_id,
        pr.prc_rule_id,
        pp.prc_pool_id,
        ts.prc_term_shr_id,
        ti.prc_tier_id,
        pm.faf_id,
        pm.prc_mstr_nm
	,ts.PRC_TYP_CD

from    client_reg.crt_clnt c
        join client_reg.crt_clnt_rule_assc ra
                on c.rbat_id=ra.rbat_id
        join client_reg.crt_prc_rule pr
                on ra.prc_rule_id=pr.prc_rule_id
        join client_reg.crt_prc_mstr pm
                on pr.prc_mstr_id=pm.prc_mstr_id
        join client_reg.crt_prc_pool pp
                on pr.prc_rule_id=pp.prc_rule_id
        join client_reg.crt_clnt_prc_pool_assc pa
                on c.rbat_id=pa.rbat_id and pp.pool_typ_cd=pa.pool_typ_cd
        join client_reg.crt_prc_term_shr ts
                on pp.prc_pool_id=ts.prc_pool_id
        join client_reg.crt_prc_tier ti
                on ts.prc_term_shr_id=ti.prc_term_id
                        and ts.PRC_TYP_CD=ti.PRC_TYP_CD

        join (select CDSET_VL, CDSET_VL_DESC_TXT
                        from client_reg.crt_cdset cd join client_reg.crt_cdset_vl cv
                                on cd.CDSET_ID=cv.CDSET_ID where CDSET_DESC_TXT='SPLIT_CLM_TYP_CD' ) base
                on ts.CLM_TYP_CD = base.CDSET_VL

        join (select CDSET_VL, CDSET_VL_DESC_TXT
                        from client_reg.crt_cdset cd join client_reg.crt_cdset_vl cv
                                on cd.CDSET_ID=cv.CDSET_ID where CDSET_DESC_TXT='CLM_TYP_QLFR_CD_ALL_MODEL' ) qbase
                on ts.CLM_TYP_QLFR_CD = qbase.CDSET_VL

,rps.quarter_summary qtr

where ti.prc_term_typ_cd='1'
and ((qtr.QTR_BEGIN_DT+1 days) between ra.eff_dt and ra.term_dt
                or (qtr.QTR_END_DT-1 days) between ra.eff_dt and ra.term_dt)
and RPS_ACTIVE_IND<>'3'



				]]></source>
				<target
					type             = "sql"
					datasource       = "datamart"
					transaction      = "true"
					batch            = "1000"
					reportInterval   = "1000"
					queryTimeout     = "${TIMEOUT}"
				><![CDATA[
					INSERT INTO rps.t_splits_base
                                         (RBAT_ID,
                                          RAC_ID,
                                          inv_qtr,
                                          PRC_TERM_TYP_CD,
                                          POOL_TYP_CD,
                                          FRMA_TYP_CD,
                                          CLM_TYP_CD,
                                          CLM_TYP_QLFR_CD,
                                          CLM_TYP_QLFR_VL,
                                          CLNT_MIN_AMT,
                                          CLNT_MAX_AMT,
                                          CLNT_MIN_TYP_CD,
                                          CLNT_MAX_TYP_CD,
                                          CLNT_SPLT_PCT,
                                          CO_SPLT_PCT,
                                          OTHR_SPLT_PCT,
                                          TIER_UP_LVL_AMT,
                                          TIER_UP_LVL_QTY,
                                          TIER_SPLT_CLNT_PCT,
                                          TIER_SPLT_CO_PCT,
                                          TIER_SPLT_OTHR_PCT,
                                          PMPM_CD,
                                          CO_1_AMT,
                                          EFF_DT,
                                          TERM_DT,
                                          PRC_MSTR_ID,
                                          PRC_RULE_ID,
                                          PRC_POOL_ID,
                                          PRC_TERM_SHR_ID,
                                          PRC_TIER_ID,
                                          FAF_ID,
                                          PRC_MSTR_NM
					,PRC_TYP_CD
					  ) 
					VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)

				]]></target>
			</command>
				 
			<command type="copy" batch="1000">
				<source type="sql" datasource="datamart"><![CDATA[
select
(case when c.rbat_id>9999999 then trim(char(c.rbat_id)) 
when c.rbat_id>999999 then '0'||trim(char(c.rbat_id)) 
when c.rbat_id>99999 then '00'||trim(char(c.rbat_id)) 
else  '000'||trim(char(c.rbat_id)) end),
        pa.rac_id,
qtr.period_id,
        ti.prc_term_typ_cd,
        pp.pool_typ_cd,
        ts.guar_typ_cd as frma_typ_cd,
        base.CDSET_VL_DESC_TXT as clm_typ_cd,
        qbase.CDSET_VL_DESC_TXT as clm_typ_qlfr_cd,
        ti.clm_typ_qlfr_vl,
ts.clnt_amt,
        ti.tier_up_lvl_amt,
        ti.tier_up_lvl_qty,
        ti.tier_splt_clnt_pct,
        ti.tier_splt_co_pct,
        ti.tier_splt_othr_pct,
        ts.pmpm_cd,
        ra.eff_dt, ra.term_dt,
        pm.prc_mstr_id,
        pr.prc_rule_id,
        pp.prc_pool_id,
        ts.prc_term_guar_id,
        ti.prc_tier_id,
        pm.faf_id,
        pm.prc_mstr_nm
	,ts.PRC_TYP_CD

from    client_reg.crt_clnt c
        join client_reg.crt_clnt_rule_assc ra
                on c.rbat_id=ra.rbat_id
        join client_reg.crt_prc_rule pr
                on ra.prc_rule_id=pr.prc_rule_id
        join client_reg.crt_prc_mstr pm
                on pr.prc_mstr_id=pm.prc_mstr_id
        join client_reg.crt_prc_pool pp
                on pr.prc_rule_id=pp.prc_rule_id
        join client_reg.crt_clnt_prc_pool_assc pa
                on c.rbat_id=pa.rbat_id and pp.pool_typ_cd=pa.pool_typ_cd
        join client_reg.crt_prc_term_guar ts
                on pp.prc_pool_id=ts.prc_pool_id
        join client_reg.crt_prc_tier ti
                on ts.prc_term_guar_id=ti.prc_term_id
                        and ts.PRC_TYP_CD=ti.PRC_TYP_CD

        join (select CDSET_VL, CDSET_VL_DESC_TXT
                        from client_reg.crt_cdset cd join client_reg.crt_cdset_vl cv
                                on cd.CDSET_ID=cv.CDSET_ID where CDSET_DESC_TXT='SPLIT_CLM_TYP_CD' ) base
                on ts.CLM_TYP_CD = base.CDSET_VL

        join (select CDSET_VL, CDSET_VL_DESC_TXT
                        from client_reg.crt_cdset cd join client_reg.crt_cdset_vl cv
                                on cd.CDSET_ID=cv.CDSET_ID where CDSET_DESC_TXT='CLM_TYP_QLFR_CD_ALL_MODEL' ) qbase
                on ts.CLM_TYP_QLFR_CD = qbase.CDSET_VL

,rps.quarter_summary qtr

where ti.prc_term_typ_cd='2'
and ((qtr.QTR_BEGIN_DT+1 days) between ra.eff_dt and ra.term_dt
                or (qtr.QTR_END_DT-1 days) between ra.eff_dt and ra.term_dt)
and RPS_ACTIVE_IND<>'3'
and ((ts.guar_typ_cd='2' and ti.clm_typ_qlfr_vl<>'99') or ts.guar_typ_cd='1')


				]]></source>
				<target
					type             = "sql"
					datasource       = "datamart"
					transaction      = "true"
					batch            = "1000"
					reportInterval   = "1000"
					queryTimeout     = "${TIMEOUT}"
				><![CDATA[
					INSERT INTO rps.t_splits_base
                                         (RBAT_ID,
                                          RAC_ID,
                                          inv_qtr,
                                          PRC_TERM_TYP_CD,
                                          POOL_TYP_CD,
                                          FRMA_TYP_CD,
                                          CLM_TYP_CD,
                                          CLM_TYP_QLFR_CD,
                                          CLM_TYP_QLFR_VL,
                                          CLNT_MIN_AMT,
                                          TIER_UP_LVL_AMT,
                                          TIER_UP_LVL_QTY,
                                          TIER_SPLT_CLNT_PCT,
                                          TIER_SPLT_CO_PCT,
                                          TIER_SPLT_OTHR_PCT,
                                          PMPM_CD,
                                          EFF_DT,
                                          TERM_DT,
                                          PRC_MSTR_ID,
                                          PRC_RULE_ID,
                                          PRC_POOL_ID,
                                          PRC_TERM_SHR_ID,
                                          PRC_TIER_ID,
                                          FAF_ID,
                                          PRC_MSTR_NM
					,PRC_TYP_CD
					  ) 
					VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)

				]]></target>
			</command>

		</try>
		<catch>
		</catch>
		
        </command>
</sqml>

